// SAGE Premium - Unified build
// Generated by combining config.js, auth.js, map.js, ee-computations.js, app.js

// SAGE Egypt - Configuration
var CONFIG = {
    CLIENT_ID: '630643291056-u687ibvpr8oqpaalbo3qjig3r1659bap.apps.googleusercontent.com',
    PROJECT_ID: 'ee-eelmadawy399',
    SCOPES: [
        'https://www.googleapis.com/auth/earthengine',
        'https://www.googleapis.com/auth/devstorage.read_only'
    ],
    MAP_CENTER: [26.8, 30.8],  // Egypt center [lat, lng]
    MAP_ZOOM: 6,
    DEFAULT_BUFFER: 500  // meters
};

// SAGE Egypt - Authentication Module
// Uses modern Google Identity Services (GIS) + Earth Engine

var tokenClient;

function showLoading(text) {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    document.getElementById('loadingText').textContent = text || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.add('hidden');
}

function initAuthClient() {
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CONFIG.CLIENT_ID,
            scope: CONFIG.SCOPES.join(' '),
            callback: function (response) {
                if (response.error) {
                    hideLoading();
                    console.error('Auth error:', response);
                    if (response.error === 'popup_closed_by_user') {
                        alert('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.\nPlease try again and complete the login.');
                    } else {
                        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + response.error + '\n' + (response.error_description || ''));
                    }
                    return;
                }

                // Set token in EE
                showLoading('Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Earth Engine...');
                console.log('âœ… Got access token, initializing EE...');

                ee.data.setAuthToken(
                    null,
                    'Bearer',
                    response.access_token,
                    3600,
                    [],
                    null,
                    false
                );

                ee.initialize(
                    null,
                    null,
                    function () {
                        hideLoading();
                        onAuthSuccess();
                    },
                    function (err) {
                        hideLoading();
                        console.error('EE init error:', err);
                        alert('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Earth Engine:\n' + err);
                    },
                    null,
                    CONFIG.PROJECT_ID
                );
            },
            error_callback: function (err) {
                // This handles popup blocked / popup closed errors
                hideLoading();
                console.error('Token client error:', err);
                if (err.type === 'popup_failed_to_open') {
                    alert('âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ Ø­Ø¬Ø¨ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©!\n\nØ§Ù„Ø­Ù„: Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Popups) Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.\n\nAllow popups for this site and try again.');
                } else if (err.type === 'popup_closed') {
                    alert('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                } else {
                    alert('Ø®Ø·Ø£: ' + (err.message || err.type || JSON.stringify(err)));
                }
            }
        });
        console.log('âœ… Token client initialized');
    } catch (e) {
        console.error('Failed to init token client:', e);
        alert('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Google Identity Services:\n' + e.message);
    }
}

function startAuth() {
    if (!tokenClient) {
        alert('Google Identity Services Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
        return;
    }
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');

    // Safety timeout: hide loading after 30 seconds if nothing happens
    window._authTimeout = setTimeout(function () {
        hideLoading();
        console.warn('Auth timeout - popup may have been blocked');
    }, 30000);

    try {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    } catch (e) {
        hideLoading();
        console.error('requestAccessToken error:', e);
        alert('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:\n' + e.message);
    }
}

function onAuthSuccess() {
    clearTimeout(window._authTimeout);
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('appContainer').classList.remove('hidden');

    initMap();
    showWelcome();

    console.log('âœ… SAGE Egypt initialized successfully!');
}

// Initialize GIS client when the library loads
window.addEventListener('load', function () {
    setTimeout(function () {
        if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
            initAuthClient();
        } else {
            console.warn('Waiting for Google Identity Services...');
            setTimeout(function () {
                if (typeof google !== 'undefined' && google.accounts) {
                    initAuthClient();
                } else {
                    console.error('âŒ Google Identity Services failed to load!');
                    alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø®Ø¯Ù…Ø© Google. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
                }
            }, 2000);
        }
    }, 500);
});

// SAGE Egypt - Map Module
// Handles Leaflet map initialization and EE tile layers

var map;
var currentLayers = {};
var currentMarker = null;

function initMap() {
    map = L.map('map', {
        center: CONFIG.MAP_CENTER,
        zoom: CONFIG.MAP_ZOOM,
        zoomControl: true,
        attributionControl: false
    });

    // Add satellite base layer
    L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        attribution: 'Â© Google'
    }).addTo(map);

    // Map click handler
    map.on('click', function (e) {
        if (window.mapClickEnabled) {
            onMapClick(e.latlng.lat, e.latlng.lng);
        }
    });

    console.log('ğŸ—ºï¸ Map initialized');
}

// Add EE image as tile layer
function addEELayer(eeImage, visParams, name) {
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø©...');

    eeImage.getMap(visParams, function (mapObj) {
        // Remove old layer with same name
        if (currentLayers[name]) {
            map.removeLayer(currentLayers[name]);
        }

        var tileLayer = L.tileLayer(mapObj.urlFormat, {
            maxZoom: 20,
            opacity: 0.7
        });

        tileLayer.addTo(map);
        currentLayers[name] = tileLayer;
        hideLoading();
    });
}

// Remove a layer by name
function removeEELayer(name) {
    if (currentLayers[name]) {
        map.removeLayer(currentLayers[name]);
        delete currentLayers[name];
    }
}

// Clear all EE layers
function clearEELayers() {
    for (var name in currentLayers) {
        map.removeLayer(currentLayers[name]);
    }
    currentLayers = {};
}

// Add a marker
function addMarker(lat, lng, label) {
    if (currentMarker) {
        map.removeLayer(currentMarker);
    }
    currentMarker = L.marker([lat, lng])
        .addTo(map)
        .bindPopup(label || 'ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯')
        .openPopup();
    return currentMarker;
}

// Add a circle (buffer area)
function addBufferCircle(lat, lng, radius) {
    return L.circle([lat, lng], {
        radius: radius,
        color: '#4CAF50',
        fillColor: '#4CAF5044',
        fillOpacity: 0.3,
        weight: 2
    }).addTo(map);
}

// Center map on location
function centerMap(lat, lng, zoom) {
    map.setView([lat, lng], zoom || 14);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAGE Egypt â€” Earth Engine Computation Module
// Ported from SAGE_FREE.js (all scientific logic)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1) SENTINEL-2 PREPARATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1) SENTINEL-2 PREPARATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function maskAndPrepareS2(img) {
    // Debug: Check if img is valid
    // console.log('Processing S2 Image:', img.id()); 
    var scl = img.select('SCL');
    var clearMask = scl.neq(3)  // Cloud Shadow
        .and(scl.neq(8))       // Cloud Medium
        .and(scl.neq(9))       // Cloud High
        .and(scl.neq(10))      // Cirrus
        .and(scl.neq(11));     // Snow/Ice
    return img.updateMask(clearMask)
        .select(['B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B8A', 'B11', 'B12'],
            ['BLUE', 'GREEN', 'RED', 'RE1', 'RE2', 'RE3', 'NIR', 'NIR2', 'SWIR1', 'SWIR2'])
        .divide(10000)
        .copyProperties(img, ['system:time_start']);
}

function getS2Collection(start, end, geometry) {
    console.log('ğŸ“¡ GEE: Requesting Sentinel-2 Collection...', { start, end });
    var col = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
        .filterBounds(geometry)
        .filterDate(start, end)
        .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 30));

    // Asynchronous check for collection size (non-blocking log)
    col.size().evaluate(function (s, e) {
        if (e) console.error('âŒ GEE Error (S2):', e);
        else console.log('âœ… GEE Success (S2): Found ' + s + ' images.');
    });

    return col.map(maskAndPrepareS2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2) INDICES DICTIONARY (20+ Indices)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var indicesDict = {
    'NDVI': function (img) {
        return img.normalizedDifference(['NIR', 'RED']).rename('NDVI');
    },
    'EVI': function (img) {
        return img.expression(
            '2.5 * ((NIR - RED) / (NIR + 6*RED - 7.5*BLUE + 1))',
            { NIR: img.select('NIR'), RED: img.select('RED'), BLUE: img.select('BLUE') }
        ).rename('EVI');
    },
    'SAVI': function (img) {
        return img.expression(
            '1.5 * (NIR - RED) / (NIR + RED + 0.5)',
            { NIR: img.select('NIR'), RED: img.select('RED') }
        ).rename('SAVI');
    },
    'NDMI': function (img) {
        return img.normalizedDifference(['NIR', 'SWIR1']).rename('NDMI');
    },
    'GCI': function (img) {
        return img.select('NIR').divide(img.select('GREEN')).subtract(1).rename('GCI');
    },
    'NDWI': function (img) {
        return img.normalizedDifference(['GREEN', 'NIR']).rename('NDWI');
    },
    'MNDWI': function (img) {
        return img.normalizedDifference(['GREEN', 'SWIR1']).rename('MNDWI');
    },
    'NDBI': function (img) {
        return img.normalizedDifference(['SWIR1', 'NIR']).rename('NDBI');
    },
    'BSI': function (img) {
        return img.expression(
            '((SWIR1 + RED) - (NIR + BLUE)) / ((SWIR1 + RED) + (NIR + BLUE))',
            { SWIR1: img.select('SWIR1'), RED: img.select('RED'), NIR: img.select('NIR'), BLUE: img.select('BLUE') }
        ).rename('BSI');
    },
    'NBR': function (img) {
        return img.normalizedDifference(['NIR', 'SWIR2']).rename('NBR');
    },
    'NDSI': function (img) {
        return img.normalizedDifference(['SWIR1', 'SWIR2']).rename('NDSI');
    },
    'ClayRatio': function (img) {
        return img.select('SWIR1').divide(img.select('SWIR2')).rename('ClayRatio');
    },
    'IronOxide': function (img) {
        return img.select('RED').divide(img.select('BLUE')).rename('IronOxide');
    },
    'GypsumIndex': function (img) {
        return img.expression(
            '(SWIR1 - SWIR2) / (SWIR1 + SWIR2)',
            { SWIR1: img.select('SWIR1'), SWIR2: img.select('SWIR2') }
        ).rename('GypsumIndex');
    },
    'CarbonateIndex': function (img) {
        return img.expression('SWIR2 / SWIR1',
            { SWIR1: img.select('SWIR1'), SWIR2: img.select('SWIR2') }
        ).rename('CarbonateIndex');
    },
    'ESI': function (img) {
        return img.expression('sqrt((RED + NIR) / 2)',
            { RED: img.select('RED'), NIR: img.select('NIR') }
        ).rename('ESI');
    },
    'SI3': function (img) {
        return img.expression('sqrt(BLUE * RED)',
            { BLUE: img.select('BLUE'), RED: img.select('RED') }
        ).rename('SI3');
    },
    'SOM': function (img) {
        return img.expression(
            '(1 - ((SWIR2 - SWIR2min) / (SWIR2max - SWIR2min))) * (NIR / RED)',
            { SWIR2: img.select('SWIR2'), NIR: img.select('NIR'), RED: img.select('RED'), SWIR2min: 0.05, SWIR2max: 0.35 }
        ).rename('SOM');
    },
    'Turbidity': function (img) {
        return img.select('RED').divide(img.select('BLUE')).rename('Turbidity');
    },
    'Chlorophyll-a': function (img) {
        return img.expression(
            '(NIR - RED) / (NIR + RED) * 10',
            { NIR: img.select('NIR'), RED: img.select('RED') }
        ).rename('Chla');
    }
};

var visParamsDict = {
    'NDVI': { min: 0, max: 0.8, palette: ['#FFFFFF', '#CE7E45', '#DF923D', '#F1B555', '#FCD163', '#99B718', '#74A901', '#66A000', '#529400', '#3E8601', '#207401', '#056201', '#004C00', '#023B01', '#012E01', '#011D01', '#011301'] },
    'EVI': { min: 0, max: 0.8, palette: ['white', 'yellow', 'green', 'darkgreen'] },
    'SAVI': { min: 0, max: 0.8, palette: ['white', 'yellow', 'green', 'darkgreen'] },
    'NDMI': { min: -0.2, max: 0.6, palette: ['#E0F7FA', '#B2EBF2', '#80DEEA', '#4DD0E1', '#26C6DA', '#00ACC1', '#0097A7', '#00838F', '#006064'] },
    'GCI': { min: 0, max: 5, palette: ['white', 'green'] },
    'NDWI': { min: -1, max: 0.5, palette: ['red', 'white', 'blue'] },
    'MNDWI': { min: -1, max: 0.5, palette: ['red', 'white', 'blue'] },
    'NDBI': { min: -0.5, max: 0.5, palette: ['green', 'white', 'red'] },
    'BSI': { min: -0.15, max: 0.35, palette: ['green', 'white', 'brown'] },
    'NBR': { min: -1, max: 1, palette: ['#334D33', '#111111', '#FF0000', '#00FF00', '#FFFF00'] },
    'NDSI': { min: -1, max: 1, palette: ['red', 'white', 'cyan'] },
    'ClayRatio': { min: 0.5, max: 2.5, palette: ['blue', 'white', 'red'] },
    'IronOxide': { min: 0.5, max: 2.5, palette: ['blue', 'white', 'red'] },
    'GypsumIndex': { min: -0.2, max: 0.2, palette: ['blue', 'white', 'red'] },
    'CarbonateIndex': { min: 0.5, max: 1.5, palette: ['blue', 'white', 'red'] },
    'ESI': { min: 0.1, max: 0.6, palette: ['red', 'yellow', 'green'] },
    'SI3': { min: 0, max: 0.4, palette: ['white', 'blue', 'purple'] },
    'SOM': { min: 0, max: 1, palette: ['#D7C29E', '#BB9E70', '#8B6A3D', '#5D4037', '#3E2723'] },
    'Turbidity': { min: 0.5, max: 2.0, palette: ['blue', 'green', 'yellow', 'brown'] },
    'Chlorophyll-a': { min: 0, max: 5, palette: ['white', 'green', 'darkgreen'] }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helper: Get Collection by Sensor Name
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAnyCollection(sensor, start, end, region) {
    if (sensor === 'Sentinel-2') return getS2Collection(start, end, region);
    if (sensor === 'Landsat 8') return getMergedLandsatCollection(start, end, region).filter(ee.Filter.eq('SATELLITE', 'LANDSAT_8'));
    if (sensor === 'Landsat 7') return getMergedLandsatCollection(start, end, region).filter(ee.Filter.eq('SATELLITE', 'LANDSAT_7'));
    if (sensor === 'Landsat 5') return getMergedLandsatCollection(start, end, region).filter(ee.Filter.eq('SATELLITE', 'LANDSAT_5'));
    return getS2Collection(start, end, region);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3) SENTINEL-1 (SAR) DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getS1Collection(start, end, region) {
    return ee.ImageCollection('COPERNICUS/S1_GRD')
        .filterDate(start, end)
        .filterBounds(region)
        .filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VV'))
        .filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VH'))
        .filter(ee.Filter.eq('instrumentMode', 'IW'))
        .map(function (img) {
            var vv_smoothed = img.select('VV').focal_median(30, 'circle', 'meters').rename('VV_smoothed');
            var vh_smoothed = img.select('VH').focal_median(30, 'circle', 'meters').rename('VH_smoothed');
            return img.addBands([vv_smoothed, vh_smoothed]).copyProperties(img, ['system:time_start']);
        });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4) SALINITY MODEL (V2.5 â€” Additive Multi-Evidence)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function estimateSalinity_ML(s2, s1, lst, precip, et, dem, slope) {
    // 1. Vegetation suppression
    var ndvi = s2.normalizedDifference(['NIR', 'RED']).unmask(0);
    var ndvi_inv = ndvi.multiply(-1);
    var ndmi = s2.normalizedDifference(['NIR', 'SWIR1']).unmask(0);
    var ndmi_inv = ndmi.multiply(-1);
    var vegFactor = ndvi.unitScale(0.25, 0.6).clamp(0, 1);
    var soilWeight = ee.Image(1).subtract(vegFactor);

    // 1b. Urban suppression
    var ndbi = s2.normalizedDifference(['SWIR1', 'NIR']).unmask(0);
    var urbanFactor = ndbi.unitScale(0.0, 0.3).clamp(0, 1);
    soilWeight = soilWeight.multiply(ee.Image(1).subtract(urbanFactor));

    // 2. Optical salinity indices
    var si1 = s2.expression('sqrt(GREEN * RED)', { GREEN: s2.select('GREEN'), RED: s2.select('RED') }).unmask(0);
    var si2 = s2.expression('sqrt(RED * NIR)', { RED: s2.select('RED'), NIR: s2.select('NIR') }).unmask(0);
    var si3 = s2.normalizedDifference(['SWIR1', 'SWIR2']).unmask(0);

    // 3. SAR response
    var vv = s1.select('VV_smoothed').unmask(-15).clamp(-25, -5);
    var vh = s1.select('VH_smoothed').unmask(-22).clamp(-30, -10);
    var pol_ratio = vv.subtract(vh).clamp(-10, 10);

    // 4. Environmental factors
    var elev_norm = dem.unitScale(0, 300).clamp(0, 1).unmask(0.5);
    var lst_norm = lst.unitScale(15, 50).unmask(0.5);
    var waterDeficit = et.subtract(precip).divide(et.add(0.1)).unmask(0.8);

    // 5. Soft desert modulation
    var spectral_salt_evidence = si3.unitScale(0, 0.12).clamp(0, 1);
    var env_modulator = spectral_salt_evidence.multiply(0.7).add(0.3);

    // 6. Final equation
    var ec_estimated = ee.Image(1.0)
        .add(
            si1.multiply(1.0).add(si2.multiply(1.2)).add(si3.multiply(2.0))
                .add(ndvi_inv.multiply(1.0)).add(ndmi_inv.multiply(1.2))
                .multiply(soilWeight)
        )
        .add(
            vv.multiply(-0.1).add(pol_ratio.multiply(0.8))
                .multiply(soilWeight.add(0.1))
        )
        .add(elev_norm.multiply(-1.5))
        .add(
            lst_norm.multiply(1.0).add(waterDeficit.multiply(1.5))
                .multiply(soilWeight.add(0.05))
                .multiply(env_modulator)
        )
        .clamp(0.5, 30)
        .rename('EC_dSm');

    return ec_estimated;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4b) VEGETATION HEALTH INDEX (VHI)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calculateVHI(start, end, region) {
    var fullHistory = getMergedLandsatCollection('1984-01-01', ee.Date(Date.now()).format('YYYY-MM-dd'), region);
    var historyNdvi = fullHistory.map(function (img) { return indicesDict['NDVI'](img); });
    var historyLst = fullHistory.select('LST');

    var ndviMin = historyNdvi.min();
    var ndviMax = historyNdvi.max();
    var lstMin = historyLst.min();
    var lstMax = historyLst.max();

    var currentCol = getMergedLandsatCollection(start, end, region);
    var result = currentCol.median();
    var currentNdvi = indicesDict['NDVI'](result);
    var currentLst = result.select('LST');

    var vci = currentNdvi.subtract(ndviMin).divide(ndviMax.subtract(ndviMin)).rename('VCI');
    var tci = lstMax.subtract(currentLst).divide(lstMax.subtract(lstMin)).rename('TCI');

    return vci.multiply(0.5).add(tci.multiply(0.5)).rename('VHI').clip(region);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4c) DROUGHT ASSESSMENT (Multi-Sensor)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calculateDroughtIndex(start, end, region) {
    var s2 = getS2Collection(start, end, region).median();
    var ls_col = getMergedLandsatCollection(start, end, region);
    var lst = ls_col.select('LST').median();
    var era5 = getEra5(start, end, region);
    var sm_rootzone = era5.select('sm_rootzone_m3m3');

    var ndvi = indicesDict['NDVI'](s2).unitScale(-0.2, 0.8);
    var ndmi = indicesDict['NDMI'](s2).unitScale(-0.5, 0.5);
    var lst_norm = lst.unitScale(20, 50).multiply(-1).add(1);
    var sm_norm = sm_rootzone.unitScale(0.1, 0.35);

    var cdi = ndvi.multiply(0.3).add(ndmi.multiply(0.3)).add(lst_norm.multiply(0.2)).add(sm_norm.multiply(0.2)).rename('CDI');
    return cdi.clip(region);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4d) DESERTIFICATION RISK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calculateDesertRisk(start, end, region) {
    var s2 = getS2Collection(start, end, region).median();
    var ls_col = getMergedLandsatCollection(start, end, region);
    var lst = ls_col.select('LST').median();
    var era5 = getEra5(start, end, region);
    var sm_rootzone = era5.select('sm_rootzone_m3m3');

    var ndvi_risk = indicesDict['NDVI'](s2).unitScale(0.1, 0.6).multiply(-1).add(1);
    var bsi_risk = indicesDict['BSI'](s2).unitScale(-0.3, 0.5);
    var lst_risk = lst.unitScale(25, 50);
    var sm_risk = sm_rootzone.unitScale(0.1, 0.35).multiply(-1).add(1);

    var desert_risk = ndvi_risk.multiply(0.3).add(bsi_risk.multiply(0.3)).add(lst_risk.multiply(0.2)).add(sm_risk.multiply(0.2)).rename('DesertRisk');
    return desert_risk.clip(region);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5) LANDSAT HELPERS (Cloud mask, Scale, Merged Collection)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function cloudMaskLandsat(img) {
    var qa = img.select('QA_PIXEL');
    var mask = qa.bitwiseAnd(1 << 1).eq(0)
        .and(qa.bitwiseAnd(1 << 2).eq(0))
        .and(qa.bitwiseAnd(1 << 3).eq(0))
        .and(qa.bitwiseAnd(1 << 4).eq(0));
    return img.updateMask(mask).copyProperties(img, img.propertyNames());
}

function applyScaleFactors(img) {
    var optical = img.select('SR_B.*').multiply(2.75e-5).subtract(0.2);
    var thermal = img.select('ST_B.*').multiply(0.00341802).add(149.0).subtract(273.15);
    return img.addBands(optical, null, true).addBands(thermal, null, true)
        .copyProperties(img, img.propertyNames());
}

function getMergedLandsatCollection(start, end, geometry) {
    var l8_BANDS = ['SR_B2', 'SR_B3', 'SR_B4', 'SR_B5', 'SR_B6', 'SR_B7', 'ST_B10'];
    var l57_BANDS = ['SR_B1', 'SR_B2', 'SR_B3', 'SR_B4', 'SR_B5', 'SR_B7', 'ST_B6'];
    var COMMON_BANDS = ['BLUE', 'GREEN', 'RED', 'NIR', 'SWIR1', 'SWIR2', 'LST'];

    var l8 = ee.ImageCollection('LANDSAT/LC08/C02/T1_L2')
        .filterDate(start, end).filterBounds(geometry)
        .map(cloudMaskLandsat).map(applyScaleFactors).select(l8_BANDS, COMMON_BANDS);

    var l7 = ee.ImageCollection('LANDSAT/LE07/C02/T1_L2')
        .filterDate(start, end).filterBounds(geometry)
        .map(cloudMaskLandsat).map(applyScaleFactors).select(l57_BANDS, COMMON_BANDS);

    var l5 = ee.ImageCollection('LANDSAT/LT05/C02/T1_L2')
        .filterDate(start, end).filterBounds(geometry)
        .map(cloudMaskLandsat).map(applyScaleFactors).select(l57_BANDS, COMMON_BANDS);

    return ee.ImageCollection(l5.merge(l7).merge(l8));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6) CLIMATE DATA LOADERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getChirps(start, end, geometry) {
    var startDate = ee.Date(start);
    var endDate = ee.Date(end);
    var col = ee.ImageCollection('UCSB-CHG/CHIRPS/DAILY')
        .filterBounds(geometry)
        .filterDate(startDate.advance(-1, 'month'), endDate);
    var count = col.size();
    var result = ee.Algorithms.If(count.gt(0),
        col.sum().rename('Precipitation'),
        ee.Image(10).rename('Precipitation'));
    return ee.Image(result);
}

function getModisET(start, end, geometry) {
    var startDate = ee.Date(start);
    var endDate = ee.Date(end);
    var col = ee.ImageCollection('MODIS/061/MOD16A2GF')
        .filterBounds(geometry)
        .filterDate(startDate.advance(-2, 'month'), endDate)
        .select('ET');
    var count = col.size();
    var dailyEt = col.map(function (img) {
        return img.multiply(0.1).divide(8).copyProperties(img, ['system:time_start']);
    });
    var result = ee.Algorithms.If(count.gt(0),
        dailyEt.mean().rename('ET'),
        ee.Image(5).rename('ET'));
    return ee.Image(result);
}

function getEra5(start, end, geometry) {
    var era_bands = ['skin_temperature', 'volumetric_soil_water_layer_1',
        'volumetric_soil_water_layer_2', 'total_evaporation_sum',
        'temperature_2m', 'dewpoint_temperature_2m',
        'u_component_of_wind_10m', 'v_component_of_wind_10m'];
    var new_names = ['skin_temp_K', 'sm_topsoil_m3m3', 'sm_rootzone_m3m3',
        'total_evap_m_sum', 'air_temp_K', 'dewpoint_temp_K', 'u_wind_ms', 'v_wind_ms'];

    var startDate = ee.Date(start);
    var endDate = ee.Date(end);
    var col = ee.ImageCollection('ECMWF/ERA5_LAND/MONTHLY_AGGR')
        .filterBounds(geometry)
        .filterDate(startDate.advance(-6, 'month'), endDate)
        .select(era_bands, new_names);

    var count = col.size();
    var meanImage = ee.Algorithms.If(count.gt(0), col.mean(),
        ee.Image([298, 0.2, 0.2, 0, 298, 298, 0, 0]).rename(new_names).updateMask(0));
    meanImage = ee.Image(meanImage);

    var skinTempC = meanImage.select('skin_temp_K').subtract(273.15).rename('skin_temp_C');
    var airTempC = meanImage.select('air_temp_K').subtract(273.15).rename('air_temp_C');
    var dewTempC = meanImage.select('dewpoint_temp_K').subtract(273.15).rename('dewpoint_temp_C');

    var rh = meanImage.expression(
        '100 * exp((17.625 * Td) / (243.04 + Td)) / exp((17.625 * T) / (243.04 + T))',
        { Td: dewTempC, T: airTempC }
    ).rename('RH');

    var windSpeed = meanImage.expression('sqrt(u*u + v*v)',
        { u: meanImage.select('u_wind_ms'), v: meanImage.select('v_wind_ms') }
    ).rename('WindSpeed');

    return meanImage.addBands(skinTempC).addBands(airTempC)
        .addBands(dewTempC).addBands(rh).addBands(windSpeed);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7) SOIL DATA (OpenLandMap)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getOpenLandMapSoil(geometry) {
    var clay = ee.Image('OpenLandMap/SOL/SOL_CLAY-WFRACTION_USDA-3A1A1A_M/v02').select('b0').rename('Clay_0cm');
    var sand = ee.Image('OpenLandMap/SOL/SOL_SAND-WFRACTION_USDA-3A1A1A_M/v02').select('b0').rename('Sand_0cm');
    var organicCarbon = ee.Image('OpenLandMap/SOL/SOL_ORGANIC-CARBON_USDA-6A1C_M/v02').select('b0').divide(10).rename('OC_0cm');
    var pH = ee.Image('OpenLandMap/SOL/SOL_PH-H2O_USDA-4C1A2A_M/v02').select('b0').divide(10).rename('pH_0cm');
    var bulkDensity = ee.Image('OpenLandMap/SOL/SOL_BULKDENS-FINEEARTH_USDA-4A1H_M/v02').select('b0').divide(1000).rename('BulkDens_0cm');
    var textureClass = ee.Image('OpenLandMap/SOL/SOL_TEXTURE-CLASS_USDA-TT_M/v02').select('b0').rename('TextureClass');
    var waterContent33 = clay.multiply(0.4).add(15).rename('WC_33kPa');

    return clay.addBands(sand).addBands(organicCarbon).addBands(pH)
        .addBands(bulkDensity).addBands(textureClass).addBands(waterContent33).clip(geometry);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8) USDA TEXTURE CLASSIFICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var textureClassNames = {
    1: 'Ø·ÙŠÙ† (Clay)', 2: 'Ø·ÙŠÙ† Ø±Ù…Ù„ÙŠ (Sandy Clay)', 3: 'Ø·ÙŠÙ† Ø³Ù„ØªÙŠ (Silty Clay)',
    4: 'Ø·ÙŠÙ† Ø±Ù…Ù„ÙŠ Ù„ÙˆÙ…ÙŠ (Sandy Clay Loam)', 5: 'Ø·ÙŠÙ† Ù„ÙˆÙ…ÙŠ (Clay Loam)',
    6: 'Ø·ÙŠÙ† Ø³Ù„ØªÙŠ Ù„ÙˆÙ…ÙŠ (Silty Clay Loam)', 7: 'Ù„ÙˆÙ…ÙŠ Ø±Ù…Ù„ÙŠ (Sandy Loam)',
    8: 'Ù„ÙˆÙ…ÙŠ (Loam)', 9: 'Ø³Ù„Øª Ù„ÙˆÙ…ÙŠ (Silt Loam)', 10: 'Ø±Ù…Ù„ÙŠ (Sand)',
    11: 'Ø±Ù…Ù„ÙŠ Ù„ÙˆÙ…ÙŠ (Loamy Sand)', 12: 'Ø³Ù„Øª (Silt)'
};

function classifyUSDATexture(clay, sand) {
    var silt = 100 - clay - sand;
    if (silt < 0) silt = 0;

    // ğŸ›‘ FIX: Prevent "Silt Bias" when data is missing (0 + 0 = 100% Silt)
    if (clay + sand <= 0.1) return 'ØºÙŠØ± Ù…ØªÙˆÙØ±';

    // 1. Ø±Ù…Ù„ÙŠ (Sand): Ø±Ù…Ù„ >= 85% ÙˆØ·ÙŠÙ† < 10%
    if (sand >= 85 && (silt + 1.5 * clay) < 15) return 'Ø±Ù…Ù„ÙŠØ© (Sand)';

    // 2. Ø±Ù…Ù„ÙŠ Ù„ÙˆÙ…ÙŠ (Loamy Sand): Ø±Ù…Ù„ 70-90%, Ø·ÙŠÙ† < 15%
    if (sand >= 70 && sand < 90 && (silt + 1.5 * clay) >= 15 && (silt + 2 * clay) < 30) return 'Ø±Ù…Ù„ÙŠØ© Ù„ÙˆÙ…ÙŠ (Loamy Sand)';

    // 3. Ø·ÙŠÙ† Ø³Ù„ØªÙŠ (Silty Clay): Ø·ÙŠÙ† >= 40% ÙˆØ³Ù„Øª >= 40%
    if (clay >= 40 && silt >= 40) return 'Ø·ÙŠÙ†ÙŠØ© Ø³Ù„ØªÙŠØ© (Silty Clay)';

    // 4. Ø·ÙŠÙ† Ø±Ù…Ù„ÙŠ (Sandy Clay): Ø·ÙŠÙ† >= 35% ÙˆØ±Ù…Ù„ >= 45%
    if (clay >= 35 && sand >= 45) return 'Ø·ÙŠÙ†ÙŠØ© Ø±Ù…Ù„ÙŠØ© (Sandy Clay)';

    // 5. Ø·ÙŠÙ† (Clay): Ø·ÙŠÙ† >= 40%
    if (clay >= 40 && sand <= 45 && silt < 40) return 'Ø·ÙŠÙ†ÙŠØ© (Clay)';

    // 6. Ø·ÙŠÙ† Ø³Ù„ØªÙŠ Ù„ÙˆÙ…ÙŠ (Silty Clay Loam): Ø·ÙŠÙ† 27-40%, Ø±Ù…Ù„ < 20%
    if (clay >= 27 && clay < 40 && sand < 20) return 'Ø·ÙŠÙ†ÙŠØ© Ø³Ù„ØªÙŠØ© Ù„ÙˆÙ…ÙŠØ© (Silty Clay Loam)';

    // 7. Ø·ÙŠÙ† Ù„ÙˆÙ…ÙŠ (Clay Loam): Ø·ÙŠÙ† 27-40%, Ø±Ù…Ù„ 20-45%
    if (clay >= 27 && clay < 40 && sand >= 20 && sand <= 45) return 'Ø·ÙŠÙ†ÙŠØ© Ù„ÙˆÙ…ÙŠØ© (Clay Loam)';

    // 8. Ø·ÙŠÙ† Ø±Ù…Ù„ÙŠ Ù„ÙˆÙ…ÙŠ (Sandy Clay Loam): Ø·ÙŠÙ† 20-35%, Ø±Ù…Ù„ > 45%
    if (clay >= 20 && clay < 35 && sand > 45) return 'Ø·ÙŠÙ†ÙŠØ© Ø·Ù…ÙŠÙŠØ© Ø±Ù…Ù„ÙŠØ© (Sandy Clay Loam)';

    // 9. Ø³Ù„Øª (Silt): Ø³Ù„Øª >= 80%, Ø·ÙŠÙ† < 12%
    if (silt >= 80 && clay < 12) return 'Ø³Ù„ØªÙŠØ© (Silt)';

    // 10. Ø³Ù„Øª Ù„ÙˆÙ…ÙŠ (Silt Loam): Ø³Ù„Øª >= 50%, Ø·ÙŠÙ† < 27%
    if (silt >= 50 && clay < 27) return 'Ø·Ù…ÙŠÙŠØ© Ø³Ù„ØªÙŠØ© (Silt Loam)';

    // 11. Ù„ÙˆÙ…ÙŠ (Loam): Ø·ÙŠÙ† 7-27%, Ø³Ù„Øª 28-50%, Ø±Ù…Ù„ <= 52%
    if (clay >= 7 && clay < 27 && silt >= 28 && silt < 50 && sand <= 52) return 'Ø·Ù…ÙŠÙŠØ© (Loam)';

    // 12. Ù„ÙˆÙ…ÙŠ Ø±Ù…Ù„ÙŠ (Sandy Loam): Ø§Ù„Ø¨Ø§Ù‚ÙŠ (Ø±Ù…Ù„ >= 43%, Ø·ÙŠÙ† < 20%)
    if (sand >= 43 && clay < 20) return 'Ø·Ù…ÙŠÙŠØ© Ø±Ù…Ù„ÙŠØ© (Sandy Loam)';

    return 'Ø·Ù…ÙŠÙŠØ© (Loam)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9) FARM VALIDATION (Scientific 3-Method)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function validateFarmLocation(geometry, start, end) {
    console.log('ğŸ” GEE: Validating Farm Location...');
    // 1. Dynamic World
    var dw = ee.ImageCollection('GOOGLE/DYNAMICWORLD/V1')
        .filterBounds(geometry).filterDate(start, end)
        .select(['crops', 'built', 'bare', 'grass', 'trees', 'water']);

    // Check if we have data
    var dwSize = dw.size();
    var hasDw = dwSize.gt(0);

    // Default/Fallback dictionary
    var fallback = ee.Dictionary({
        crops: 0, built: 0, bare: 1, grass: 0, water: 0,
        NDVI_max: 0, NDVI_min: 0, NDVI_mean: 0,
        BSI_mean: 1, NDBI_mean: 0, Albedo_mean: 1,
        NDVI_stdDev: 0
    });

    // Main Computation
    var computed = (function () {
        // Safe DW Mean
        var dwMean = ee.Image(ee.Algorithms.If(
            hasDw,
            dw.mean(),
            ee.Image.constant([0, 0, 1, 0, 0, 0]).rename(['crops', 'built', 'bare', 'grass', 'trees', 'water'])
        ));

        // 2. Sentinel-2
        var s2 = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
            .filterBounds(geometry).filterDate(start, end)
            .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 30));

        var s2Size = s2.size();
        var hasS2 = s2Size.gt(0);

        // Sub-computation for S2 (only if hasS2)
        var s2Stats = ee.Image(ee.Algorithms.If(hasS2, (function () {
            var s2Ndvi = s2.map(function (img) {
                return img.normalizedDifference(['B8', 'B4']).rename('NDVI');
            });

            // Temporal Stats
            var ndviMax = s2Ndvi.max().rename('NDVI_max');
            var ndviMin = s2Ndvi.min().rename('NDVI_min');
            var ndviMean = s2Ndvi.mean().rename('NDVI_mean');

            // Desert Indicators (from Median composite)
            var s2Med = s2.median();
            var bsi = s2Med.expression(
                '((SWIR1 + RED) - (NIR + BLUE)) / ((SWIR1 + RED) + (NIR + BLUE))',
                { SWIR1: s2Med.select('B11'), RED: s2Med.select('B4'), NIR: s2Med.select('B8'), BLUE: s2Med.select('B2') }
            ).rename('BSI_mean');
            var ndbi = s2Med.normalizedDifference(['B11', 'B8']).rename('NDBI_mean');
            var albedo = s2Med.select(['B2', 'B3', 'B4']).reduce(ee.Reducer.mean()).rename('Albedo_mean');

            // Spatial StdDev (Texture)
            var ndviStd = s2Med.normalizedDifference(['B8', 'B4'])
                .reduceRegion({
                    reducer: ee.Reducer.stdDev(),
                    geometry: geometry,
                    scale: 20,
                    maxPixels: 1e8,
                    bestEffort: true
                }).get('nd', 0);

            return dwMean
                .addBands(ndviMax)
                .addBands(ndviMin)
                .addBands(ndviMean)
                .addBands(bsi)
                .addBands(ndbi)
                .addBands(albedo)
                .set('NDVI_std_val', ndviStd);
        })(), dwMean.addBands(ee.Image([0, 0, 0, 0, 0, 0]).rename(['NDVI_max', 'NDVI_min', 'NDVI_mean', 'BSI_mean', 'NDBI_mean', 'Albedo_mean'])).set('NDVI_std_val', 0)));

        var stats = s2Stats.reduceRegion({
            reducer: ee.Reducer.mean(),
            geometry: geometry,
            scale: 30,
            maxPixels: 1e8,
            bestEffort: true
        });

        return stats.set('NDVI_stdDev', s2Stats.get('NDVI_std_val'))
            .set('observation_count', s2Size);
    })();

    var normalized = ee.Dictionary(computed).set({
        crops_prob: ee.Dictionary(computed).get('crops', 0),
        bare_prob: ee.Dictionary(computed).get('bare', 0),
        built_prob: ee.Dictionary(computed).get('built', 0),
        ndvi_max: ee.Dictionary(computed).get('NDVI_max', 0),
        ndvi_min: ee.Dictionary(computed).get('NDVI_min', 0),
        ndvi_range: ee.Number(ee.Dictionary(computed).get('NDVI_max', 0))
            .subtract(ee.Number(ee.Dictionary(computed).get('NDVI_min', 0))),
        bsi_mean: ee.Dictionary(computed).get('BSI_mean', 0),
        ndbi_mean: ee.Dictionary(computed).get('NDBI_mean', 0),
        albedo_mean: ee.Dictionary(computed).get('Albedo_mean', 0),
        ndvi_stdDev: ee.Dictionary(computed).get('NDVI_stdDev', 0)
    });

    var normalizedFallback = ee.Dictionary(fallback).set({
        crops_prob: 0,
        bare_prob: 1,
        built_prob: 0,
        ndvi_max: 0,
        ndvi_min: 0,
        ndvi_range: 0,
        bsi_mean: 1,
        ndbi_mean: 0,
        albedo_mean: 1,
        ndvi_stdDev: 0
    });

    return ee.Dictionary(ee.Algorithms.If(hasDw.or(hasS2), normalized, normalizedFallback));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10) YIELD ESTIMATOR (Simple â€” Scalar/Point)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function estimateYield_Simple(ndviVal, cropType) {
    var yields = {
        'Ù‚Ù…Ø­': { unit: 'Ø¥Ø±Ø¯Ø¨', max: 24, min: 10 },
        'Wheat': { unit: 'Ø¥Ø±Ø¯Ø¨', max: 24, min: 10 },
        'Ø°Ø±Ø©': { unit: 'Ø¥Ø±Ø¯Ø¨', max: 30, min: 12 },
        'Maize': { unit: 'Ø¥Ø±Ø¯Ø¨', max: 30, min: 12 },
        'Ø£Ø±Ø²': { unit: 'Ø·Ù†', max: 4.5, min: 1.5 },
        'Rice': { unit: 'Ø·Ù†', max: 4.5, min: 1.5 },
        'Ù‚Ø·Ù†': { unit: 'Ù‚Ù†Ø·Ø§Ø±', max: 10, min: 4 },
        'Cotton': { unit: 'Ù‚Ù†Ø·Ø§Ø±', max: 10, min: 4 },
        'Ø¨Ø·Ø§Ø·Ø³': { unit: 'Ø·Ù†', max: 25, min: 8 },
        'Potato': { unit: 'Ø·Ù†', max: 25, min: 8 },
        'Ø·Ù…Ø§Ø·Ù…': { unit: 'Ø·Ù†', max: 50, min: 15 },
        'Tomato': { unit: 'Ø·Ù†', max: 50, min: 15 }
    };

    var cropKey = null;
    for (var key in yields) {
        if (cropType && cropType.indexOf(key) > -1) { cropKey = key; break; }
    }
    if (!cropKey) return { text: 'ØºÙŠØ± Ù…ØªÙˆÙØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØµÙˆÙ„', status: 'unknown' };

    var data = yields[cropKey];
    var ndviClamped = Math.min(0.8, Math.max(0.2, ndviVal));
    var factor = (ndviClamped - 0.2) / (0.8 - 0.2);
    var estimatedYield = data.min + (factor * (data.max - data.min));
    var lower = (estimatedYield * 0.9).toFixed(1);
    var upper = (estimatedYield * 1.1).toFixed(1);

    var status = 'Ù…ØªÙˆØ³Ø· (Ø·Ø¨ÙŠØ¹ÙŠ)';
    if (factor > 0.7) status = 'Ù…Ù…ØªØ§Ø² (Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©)';
    else if (factor < 0.3) status = 'Ù…Ù†Ø®ÙØ¶ (ÙŠØ­ØªØ§Ø¬ Ø±Ø¹Ø§ÙŠØ©)';

    return { text: lower + ' - ' + upper + ' ' + data.unit + '/ÙØ¯Ø§Ù†', status: status };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 11) GROWTH STAGE DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function detectGrowthStage(ndviCol, cropType, geometry) {
    var ndviStats = ndviCol.select('NDVI').reduce(ee.Reducer.percentile([10, 50, 90]));
    var p10 = ndviStats.select('NDVI_p10').reduceRegion({ reducer: ee.Reducer.mean(), geometry: geometry, scale: 30, maxPixels: 1e9 }).get('NDVI_p10');
    var p50 = ndviStats.select('NDVI_p50').reduceRegion({ reducer: ee.Reducer.mean(), geometry: geometry, scale: 30, maxPixels: 1e9 }).get('NDVI_p50');
    var p90 = ndviStats.select('NDVI_p90').reduceRegion({ reducer: ee.Reducer.mean(), geometry: geometry, scale: 30, maxPixels: 1e9 }).get('NDVI_p90');
    return ee.Dictionary({ p10: p10, p50: p50, p90: p90 });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 12) HARVEST DATE PREDICTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function predictHarvestDate(cropType, currentNDVI) {
    var growingPeriods = {
        'Ù‚Ù…Ø­ (Wheat)': 150, 'Ø°Ø±Ø© (Maize)': 120, 'Ø£Ø±Ø² (Rice)': 140,
        'Ù‚Ø·Ù† (Cotton)': 180, 'Ù‚ØµØ¨ Ø§Ù„Ø³ÙƒØ± (Sugarcane)': 300
    };
    var totalDays = growingPeriods[cropType] || 120;
    var progress = Math.min(95, currentNDVI * 120);
    var daysElapsed = (progress / 100) * totalDays;
    var daysRemaining = Math.max(0, totalDays - daysElapsed);
    return { progress: progress, daysRemaining: Math.round(daysRemaining), totalDays: totalDays };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 13) INTERPRETATION & RECOMMENDATION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// FAO Salinity Classification
function classifySalinity(ecVal) {
    if (ecVal > 16) return { level: 'â˜ ï¸ Ø´Ø¯ÙŠØ¯Ø© Ø§Ù„Ù…Ù„ÙˆØ­Ø©', color: '#B71C1C', crops: 'ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„Ø²Ø±Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©', class: 'extreme' };
    if (ecVal > 8) return { level: 'ğŸ”´ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ù„ÙˆØ­Ø©', color: '#D32F2F', crops: 'Ø´Ø¹ÙŠØ±ØŒ Ù†Ø®ÙŠÙ„ØŒ Ø¨Ù†Ø¬Ø± Ø§Ù„Ø³ÙƒØ±', class: 'high' };
    if (ecVal > 4) return { level: 'ğŸŸ  Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù„ÙˆØ­Ø©', color: '#F57C00', crops: 'Ù‚Ù…Ø­ØŒ Ù‚Ø·Ù†ØŒ ØªÙŠÙ†ØŒ Ø±Ù…Ø§Ù†', class: 'moderate' };
    if (ecVal > 2) return { level: 'ğŸŸ¡ Ø·ÙÙŠÙØ© Ø§Ù„Ù…Ù„ÙˆØ­Ø©', color: '#FBC02D', crops: 'Ù…Ø¹Ø¸Ù… Ø§Ù„Ù…Ø­Ø§ØµÙŠÙ„ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ø¬Ø¯Ø§Ù‹', class: 'slight' };
    return { level: 'âœ… ØªØ±Ø¨Ø© Ø¹Ø°Ø¨Ø©', color: '#388E3C', crops: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ØµÙŠÙ„', class: 'none' };
}

// Crop Fertilizer Recommendations
var cropFertReqs = {
    'Ù‚Ù…Ø­ (Wheat)': { N: 75, P: 15, K: 24, note: 'ÙŠØ­ØªØ§Ø¬ Ø¯ÙØ¹Ø© ØªÙ†Ø´ÙŠØ·ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ±ÙŠØ¹' },
    'Ø°Ø±Ø© (Maize)': { N: 120, P: 30, K: 24, note: 'Ø´Ø±Ù‡ Ù„Ù„Ø¢Ø²ÙˆØªØŒ ÙŠÙ‚Ø³Ù… Ø¹Ù„Ù‰ 3 Ø¯ÙØ¹Ø§Øª' },
    'Ø£Ø±Ø² (Rice)': { N: 60, P: 15, K: 0, note: 'ÙŠÙØ¶Ù„ Ø³Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø§Ø¯Ø±' },
    'Ù‚Ø·Ù† (Cotton)': { N: 60, P: 22, K: 24, note: 'ÙŠØ­ØªØ§Ø¬ ØªÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ù†Ù…Ùˆ Ø§Ù„Ø®Ø¶Ø±ÙŠ ÙˆØ§Ù„Ø«Ù…Ø±ÙŠ' },
    'Ù‚ØµØ¨ Ø§Ù„Ø³ÙƒØ± (Sugarcane)': { N: 180, P: 45, K: 48, note: 'Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø³Ù…Ø§Ø¯ÙŠØ© Ø¶Ø®Ù…Ø©' },
    'Ø¨Ø·Ø§Ø·Ø³ (Potatoes)': { N: 150, P: 60, K: 96, note: 'Ø´Ø±Ù‡ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… Ù„ØµØ¨ Ø§Ù„Ø¯Ø±Ù†Ø§Øª' },
    'Ø·Ù…Ø§Ø·Ù… (Tomato)': { N: 100, P: 45, K: 80, note: 'Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ… Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…' },
    'ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ (Peanuts)': { N: 20, P: 30, K: 24, note: 'ÙŠØ­ØªØ§Ø¬ Ø¬Ø¨Ø³ Ø²Ø±Ø§Ø¹ÙŠ Ø¶Ø±ÙˆØ±ÙŠ (ÙƒØ§Ù„Ø³ÙŠÙˆÙ…)' },
    'Ø¨Ø±Ø³ÙŠÙ… (Alfalfa/Clover)': { N: 15, P: 22, K: 24, note: 'ÙŠØ­ØªØ§Ø¬ ÙÙˆØ³ÙÙˆØ± Ù„ØªÙ†Ø´ÙŠØ· Ø§Ù„Ø¬Ø°ÙˆØ±' },
    'Ø¨Ù†Ø¬Ø± Ø§Ù„Ø³ÙƒØ± (Sugar Beet)': { N: 80, P: 30, K: 48, note: 'ÙŠØ­ØªØ§Ø¬ Ø¨ÙˆØ±ÙˆÙ† Ù„Ø±Ø´ Ø§Ù„ÙˆØ±Ù‚' }
};

function getFertilizerRec(cropType, olmOC, olmPH, olmTexture) {
    var defaultReq = { N: 60, P: 30, K: 24, note: 'ØªÙˆØµÙŠØ© Ø¹Ø§Ù…Ø©' };
    var selectedReq = defaultReq;
    for (var key in cropFertReqs) {
        if (cropType.indexOf(key.split(' ')[0]) > -1) { selectedReq = cropFertReqs[key]; break; }
    }
    var nRec = selectedReq.N;
    var pRec = selectedReq.P;
    var kRec = selectedReq.K;
    if (olmOC !== null && olmOC / 10 < 1) nRec *= 1.2;
    if (olmPH !== null && olmPH > 8) pRec *= 1.25;
    if (olmTexture && olmTexture.indexOf('Sand') > -1) kRec *= 1.2;

    return {
        N: Math.round(nRec), P: Math.round(pRec), K: Math.round(kRec),
        note: selectedReq.note,
        urea: Math.round(nRec / 0.46),
        superPhosphate: Math.round(pRec / 0.15),
        potassiumSulfate: Math.round(kRec / 0.48)
    };
}

// Pest & Disease Risk Assessment
function assessPestRisk(cropType, rhVal, airTempVal) {
    var isWheat = cropType.indexOf('Ù‚Ù…Ø­') > -1 || cropType.indexOf('Wheat') > -1;
    var isPotato = cropType.indexOf('Ø¨Ø·Ø§Ø·Ø³') > -1 || cropType.indexOf('Potato') > -1;
    var isTomato = cropType.indexOf('Ø·Ù…Ø§Ø·Ù…') > -1 || cropType.indexOf('Tomato') > -1;

    // Spider mites: Hot + Dry
    if (airTempVal > 30 && rhVal < 40) {
        return {
            risk: 'ğŸŸ  Ø®Ø·Ø± Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª Ø§Ù„Ø£Ø­Ù…Ø±', color: 'orange',
            msg: 'Ø§Ù„Ø¬Ùˆ Ø­Ø§Ø± ÙˆØ¬Ø§Ù (' + rhVal.toFixed(0) + '%)ØŒ Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù†ÙƒØ¨ÙˆØª.'
        };
    }
    // Wheat yellow rust
    if (isWheat && rhVal > 60 && airTempVal >= 15 && airTempVal <= 25) {
        return {
            risk: 'ğŸ”´ Ø®Ø·Ø± Ø¯Ø§Ù‡Ù… (Ø§Ù„ØµØ¯Ø£ Ø§Ù„Ø£ØµÙØ±)', color: 'red',
            msg: 'Ø±Ø·ÙˆØ¨Ø© Ø¬ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ© (' + rhVal.toFixed(0) + '%) ÙˆØ­Ø±Ø§Ø±Ø© Ù…Ø¹ØªØ¯Ù„Ø©: Ø¨ÙŠØ¦Ø© Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„ØµØ¯Ø£.'
        };
    }
    if (isWheat && rhVal > 50 && airTempVal > 25) {
        return {
            risk: 'ğŸŸ  Ø®Ø·Ø± Ù…ØªÙˆØ³Ø· (ØµØ¯Ø£ Ø§Ù„Ø³Ø§Ù‚/Ø§Ù„Ø£ÙˆØ±Ø§Ù‚)', color: 'orange',
            msg: 'Ø§Ù„Ø±Ø·ÙˆØ¨Ø© ØªØ¯Ø¹Ù… Ù†Ù…Ùˆ Ø§Ù„ÙØ·Ø±ÙŠØ§Øª.'
        };
    }
    // Potato late blight
    if (isPotato && rhVal > 85 && airTempVal >= 10 && airTempVal <= 20) {
        return {
            risk: 'ğŸ”´ Ø®Ø·Ø± Ø§Ù„Ù†Ø¯ÙˆØ© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© (ÙƒØ§Ø±Ø«ÙŠ)', color: 'red',
            msg: 'Ø±Ø·ÙˆØ¨Ø© Ø¬ÙˆÙŠØ© Ù…Ø´Ø¨Ø¹Ø©! ÙŠØ¬Ø¨ Ø§Ù„Ø±Ø´ Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠ ÙÙˆØ±Ø§Ù‹.'
        };
    }
    if (isPotato && rhVal > 70) {
        return {
            risk: 'ğŸŸ  Ø®Ø·Ø± Ø§Ù„Ù†Ø¯ÙˆØ© Ø§Ù„Ù…Ø¨ÙƒØ±Ø©', color: 'orange',
            msg: 'Ø§Ù„Ø±Ø·ÙˆØ¨Ø© Ø¹Ø§Ù„ÙŠØ©ØŒ Ø§ÙØ­Øµ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ø³ÙÙ„ÙŠØ©.'
        };
    }
    // Tomato
    if (isTomato && rhVal > 80 && airTempVal < 20) {
        return {
            risk: 'ğŸ”´ Ø®Ø·Ø± Ø§Ù„Ù†Ø¯ÙˆØ© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©', color: 'red',
            msg: 'Ø±Ø·ÙˆØ¨Ø© Ù…Ø±ØªÙØ¹Ø© ÙˆØ­Ø±Ø§Ø±Ø© Ù…Ù†Ø®ÙØ¶Ø©!'
        };
    }

    return {
        risk: 'âœ… Ù…Ù†Ø®ÙØ¶Ø©', color: 'green',
        msg: 'Ø§Ù„Ø¸Ø±ÙˆÙ Ø§Ù„Ø¬ÙˆÙŠØ© (Ø­Ø±Ø§Ø±Ø© ÙˆØ±Ø·ÙˆØ¨Ø©) Ù…Ø³ØªÙ‚Ø±Ø©.'
    };
}

// Irrigation Scheduler
function calculateIrrigation(olmTexture, lstVal, windSpeedVal, currentMonth, ecRealVal, olmSand, olmClay) {
    var interval = 7;
    var soilTypeAr = 'Ø·Ù…ÙŠÙŠØ© (Ù…ØªÙˆØ³Ø·Ø©)';

    if (olmTexture && olmTexture.indexOf('Sandy Clay') > -1) { interval = 9; soilTypeAr = 'Ø·ÙŠÙ†ÙŠØ© Ø±Ù…Ù„ÙŠØ© (Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ø«Ù‚Ù„)'; }
    else if (olmTexture && olmTexture.indexOf('Clay') > -1) { interval = 12; soilTypeAr = 'Ø·ÙŠÙ†ÙŠØ© (Ø«Ù‚ÙŠÙ„Ø©)'; }
    else if (olmTexture && olmTexture.indexOf('Sand') > -1) { interval = 4; soilTypeAr = 'Ø±Ù…Ù„ÙŠØ© (Ø®ÙÙŠÙØ©)'; }

    if (lstVal > 35) interval -= 1;
    if (windSpeedVal > 5) interval -= 1;
    if (lstVal < 20) interval += 2;
    if (currentMonth >= 5 && currentMonth <= 8) interval -= 1;
    interval = Math.max(1, interval);

    var isSummer = (currentMonth >= 5 && currentMonth <= 9);
    var irrigNote;
    if (olmSand !== null && olmSand >= 70) {
        irrigNote = isSummer ? 'ğŸ’§ ØªØ±Ø¨Ø© Ø±Ù…Ù„ÙŠØ© + ØµÙŠÙ â†’ Ø±ÙŠ ÙƒÙ„ 2-3 Ø£ÙŠØ§Ù…' : 'ğŸ’§ ØªØ±Ø¨Ø© Ø±Ù…Ù„ÙŠØ© + Ø´ØªØ§Ø¡ â†’ Ø±ÙŠ ÙƒÙ„ 4-5 Ø£ÙŠØ§Ù…';
    } else if (olmClay !== null && olmClay >= 40) {
        irrigNote = isSummer ? 'ğŸ’§ ØªØ±Ø¨Ø© Ø·ÙŠÙ†ÙŠØ© + ØµÙŠÙ â†’ Ø±ÙŠ ÙƒÙ„ 5-7 Ø£ÙŠØ§Ù…' : 'ğŸ’§ ØªØ±Ø¨Ø© Ø·ÙŠÙ†ÙŠØ© + Ø´ØªØ§Ø¡ â†’ Ø±ÙŠ ÙƒÙ„ 10-14 ÙŠÙˆÙ…';
    } else {
        irrigNote = isSummer ? 'ğŸ’§ ØªØ±Ø¨Ø© Ù…ØªÙˆØ³Ø·Ø© + ØµÙŠÙ â†’ Ø±ÙŠ ÙƒÙ„ 3-5 Ø£ÙŠØ§Ù…' : 'ğŸ’§ ØªØ±Ø¨Ø© Ù…ØªÙˆØ³Ø·Ø© + Ø´ØªØ§Ø¡ â†’ Ø±ÙŠ ÙƒÙ„ 7-10 Ø£ÙŠØ§Ù…';
    }
    if (ecRealVal > 4) irrigNote += ' âš ï¸ (Ù…Ù„ÙˆØ­Ø© â†’ Ø²Ø¯ ÙƒÙ…ÙŠØ© Ø§Ù„Ø±ÙŠ 20-30%)';

    return {
        interval: interval, soilTypeAr: soilTypeAr, note: irrigNote,
        waterAmount: lstVal > 30 ? 'ØºØ²ÙŠØ± (ØµØ¨Ø§Ø­Ø§Ù‹)' : 'Ù…Ø¹ØªØ¯Ù„'
    };
}

// Spraying Guide
function assessSprayConditions(windSpeedVal, airTempVal) {
    if (windSpeedVal > 4.2) {
        return { canSpray: false, msg: 'â›” Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø±Ø´! Ø§Ù„Ø±ÙŠØ§Ø­ Ù‚ÙˆÙŠØ© (' + (windSpeedVal * 3.6).toFixed(1) + ' ÙƒÙ…/Ø³) Ø³ØªØ³Ø¨Ø¨ ØªØ·Ø§ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¯.', color: 'red' };
    }
    if (airTempVal > 30) {
        return { canSpray: false, msg: 'â›” Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ø±Ø´! Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø¹Ø§Ù„ÙŠØ© (' + airTempVal.toFixed(1) + 'Â°Ù…) Ø³ØªØ³Ø¨Ø¨ ØªØ¨Ø®Ø± Ø§Ù„Ù…Ø¨ÙŠØ¯ ÙˆØ­Ø±Ù‚ Ø§Ù„ÙˆØ±Ù‚.', color: 'red' };
    }
    return { canSpray: true, msg: 'âœ… Ø§Ù„Ø£Ø¬ÙˆØ§Ø¡ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø±Ø´ (Ø±ÙŠØ§Ø­ Ù‡Ø§Ø¯Ø¦Ø© ÙˆØ­Ø±Ø§Ø±Ø© Ù…Ø¹ØªØ¯Ù„Ø©).', color: 'green' };
}

// Expert Phenology Notes
function getExpertNote(cropType, currentMonth) {
    var isWheat = cropType.indexOf('Ù‚Ù…Ø­') > -1 || cropType.indexOf('Wheat') > -1;
    var isPotato = cropType.indexOf('Ø¨Ø·Ø§Ø·Ø³') > -1 || cropType.indexOf('Potato') > -1;
    var isTomato = cropType.indexOf('Ø·Ù…Ø§Ø·Ù…') > -1 || cropType.indexOf('Tomato') > -1;
    var isMaize = cropType.indexOf('Ø°Ø±Ø©') > -1 || cropType.indexOf('Maize') > -1;

    if (isWheat) {
        if (currentMonth === 2) return 'ğŸ’¡ Ø§Ù„Ù‚Ù…Ø­ ÙÙŠ Ù…Ø±Ø­Ù„Ø© "Ø·Ø±Ø¯ Ø§Ù„Ø³Ù†Ø§Ø¨Ù„". ØªØ¬Ù†Ø¨ Ø§Ù„Ø¹Ø·Ø´ ØªÙ…Ø§Ù…Ø§Ù‹ØŒ Ø£Ø¶Ù Ø³Ù„ÙØ§Øª Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (10 ÙƒØ¬Ù… Ø±Ø´Ø§Ù‹) Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ²Ù†.';
        if (currentMonth === 3) return 'ğŸ’¡ Ù…Ø±Ø­Ù„Ø© "Ø§Ù…ØªÙ„Ø§Ø¡ Ø§Ù„Ø­Ø¨ÙˆØ¨". Ø§Ø­Ø°Ø± Ù…Ù† Ø§Ù„Ø±ÙŠ ÙˆÙ‚Øª Ø§Ù„Ø±ÙŠØ§Ø­ Ø§Ù„Ø´Ø¯ÙŠØ¯Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ù‚Ø§Ø¯.';
        if (currentMonth === 11 || currentMonth === 12) return 'ğŸ’¡ Ù…Ø±Ø­Ù„Ø© "Ø§Ù„Ø¥Ù†Ø¨Ø§Øª ÙˆØ§Ù„ØªÙØ±ÙŠØ¹". ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ø±Ø¹Ø© Ø§Ù„Ù†Ø´Ø§Ø¯Ø± Ø§Ù„ØªÙ†Ø´ÙŠØ·ÙŠØ©.';
    }
    if (isPotato) {
        if (currentMonth === 10 || currentMonth === 11) return 'ğŸ’¡ Ø¹Ø±ÙˆØ© Ø§Ù„Ø¨Ø·Ø§Ø·Ø³ Ø§Ù„Ù†ÙŠÙ„ÙŠØ©. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ù†Ø¯ÙˆØ© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø·ÙˆØ¨Ø©.';
        if (currentMonth === 12 || currentMonth === 1) return 'ğŸ’¡ ØµØ¨ Ø§Ù„Ø¯Ø±Ù†Ø§Øª. Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù… Ø¨Ø§Ù„ØªØ³Ù…ÙŠØ¯ Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠ ÙˆØ§Ù„Ø±ÙŠ Ø§Ù„Ù…Ù†ØªØ¸Ù….';
    }
    if (isTomato) return 'ğŸ’¡ Ø§Ø­Ø°Ø± Ù…Ù† ØªØ°Ø¨Ø°Ø¨ Ø§Ù„Ø±ÙŠ Ù„ØªØ¬Ù†Ø¨ "Ø¹ÙÙ† Ø·Ø±Ù Ø§Ù„Ø³Ø±Ø©". Ø§Ù„ØªØ³Ù…ÙŠØ¯ Ø§Ù„ÙƒØ§Ù„Ø³ÙŠ Ø¶Ø±ÙˆØ±ÙŠ Ø§Ù„Ø¢Ù†.';
    if (isMaize && currentMonth >= 6 && currentMonth <= 8) return 'ğŸ’¡ Ù…Ø±Ø­Ù„Ø© "Ø§Ù„ØªØ²Ù‡ÙŠØ± ÙˆØªÙƒÙˆÙŠÙ† Ø§Ù„ÙƒÙˆØ²". Ø§Ø­ØªÙŠØ§Ø¬ Ù…Ø§Ø¦ÙŠ Ø¹Ø§Ù„Ù Ø¬Ø¯Ø§Ù‹ØŒ Ø§Ø­Ø°Ø± Ù…Ù† Ø§Ù„Ø¹Ø·Ø´.';
    return null;
}

// Leaching Requirement
function calculateLeachingReq(ecRealVal, cropType) {
    var toleranceMap = {
        'ÙØ±Ø§ÙˆÙ„Ø©': 1, 'ÙØ§ØµÙˆÙ„ÙŠØ§': 1, 'Ø¨Ø±ØªÙ‚Ø§Ù„': 2, 'Ø°Ø±Ø©': 2, 'Ø·Ù…Ø§Ø·Ù…': 2,
        'Ù‚Ù…Ø­': 3, 'Ù‚Ø·Ù†': 3, 'Ø´Ø¹ÙŠØ±': 4, 'Ø¨Ù†Ø¬Ø±': 4, 'Ù†Ø®ÙŠÙ„': 4
    };
    var toleranceValues = [1.5, 2.5, 6.0, 10.0, 12.0];

    var targetIdx = 2;
    for (var k in toleranceMap) {
        if (cropType.indexOf(k) > -1) { targetIdx = toleranceMap[k]; break; }
    }
    var targetEC = toleranceValues[Math.min(4, targetIdx)];
    if (!targetEC) targetEC = 6.0;

    function calcLR(ecw) {
        var denom = (5 * targetEC) - ecw;
        if (denom <= 0) return 1.0;
        return Math.min(0.5, Math.max(0, ecw / denom));
    }

    return {
        nile: { lr: calcLR(0.5), minutes: Math.round(calcLR(0.5) * 60), label: 'Ù…ÙŠØ§Ù‡ Ø§Ù„Ù†ÙŠÙ„ (0.5 dS/m)' },
        well: { lr: calcLR(1.5), minutes: Math.round(calcLR(1.5) * 60), label: 'Ø¢Ø¨Ø§Ø± Ù…ØªÙˆØ³Ø·Ø© (1.5 dS/m)' },
        saline: { lr: calcLR(3.0), minutes: Math.round(calcLR(3.0) * 60), label: 'Ø¢Ø¨Ø§Ø± Ù…Ø§Ù„Ø­Ø© (3.0 dS/m)', impossible: calcLR(3.0) > 0.45 }
    };
}

// Crop Tolerance Check
function checkCropSalinityTolerance(cropType, csiVal) {
    var toleranceMap = {
        'ÙØ±Ø§ÙˆÙ„Ø©': 1, 'ÙØ§ØµÙˆÙ„ÙŠØ§': 1, 'Ø¨Ø±ØªÙ‚Ø§Ù„': 2, 'Ø°Ø±Ø©': 2, 'Ø·Ù…Ø§Ø·Ù…': 2,
        'Ù‚Ù…Ø­': 3, 'Ù‚Ø·Ù†': 3, 'Ø´Ø¹ÙŠØ±': 4, 'Ø¨Ù†Ø¬Ø±': 4, 'Ù†Ø®ÙŠÙ„': 4
    };
    var currentClassIndex = 0;
    if (csiVal >= 0.75) currentClassIndex = 4;
    else if (csiVal >= 0.55) currentClassIndex = 3;
    else if (csiVal >= 0.35) currentClassIndex = 2;
    else if (csiVal >= 0.20) currentClassIndex = 1;

    var cropKey = null;
    for (var k in toleranceMap) {
        if (cropType.indexOf(k) > -1) { cropKey = k; break; }
    }
    if (cropKey && currentClassIndex > toleranceMap[cropKey]) {
        return { compatible: false, classIndex: currentClassIndex };
    }
    return { compatible: true, classIndex: currentClassIndex };
}

// Traffic Light Status
function getTrafficLight(ecRealVal, ndviVal, bsiVal) {
    if (ecRealVal > 8 || (ndviVal < 0.1 && bsiVal > 0.3)) {
        return { label: 'ğŸ”´ Ø­Ø§Ù„Ø© Ø­Ø±Ø¬Ø© â€” ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„ ÙÙˆØ±ÙŠ', bg: '#FFCDD2', color: '#B71C1C' };
    }
    if (ecRealVal > 4 || ndviVal < 0.25) {
        return { label: 'ğŸŸ¡ ØªØ­ØªØ§Ø¬ Ø§Ù†ØªØ¨Ø§Ù‡ â€” Ø§ØªØ¨Ø¹ Ø§Ù„ØªÙˆØµÙŠØ§Øª', bg: '#FFF9C4', color: '#F57F17' };
    }
    return { label: 'ğŸŸ¢ Ø£Ø±Ø¶Ùƒ Ø¨Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø© â€” Ø§Ø³ØªÙ…Ø±', bg: '#C8E6C9', color: '#1B5E20' };
}

// Health Score Calculation
function calculateHealthScore(ndviVal, vhiVal, csiVal, droughtRiskVal, isInvalidForCrop) {
    if (isInvalidForCrop) return 0;
    var ndviScore = Math.min(100, Math.max(0, (ndviVal - 0.1) / 0.7 * 100));
    var healthScore = (ndviScore * 0.3) + (vhiVal * 0.7);
    if (csiVal > 0.6) healthScore = Math.min(healthScore, 30);
    else if (csiVal > 0.4) healthScore = Math.min(healthScore, 50);
    if (droughtRiskVal > 0.6) healthScore = Math.min(healthScore, 55);
    return healthScore;
}

// Safe value extraction helper
function safeGet(obj, key1, key2Sub, defaultVal) {
    try {
        if (!obj || !obj[key1]) return defaultVal;
        var inner = obj[key1];
        if (inner[key2Sub] !== undefined && inner[key2Sub] !== null) return inner[key2Sub];
        var keys = Object.keys(inner);
        for (var k = 0; k < keys.length; k++) {
            var currentKey = keys[k];
            if (currentKey.indexOf(key2Sub) > -1 || currentKey.indexOf('_mean') > -1 || currentKey === 'mean') {
                if (inner[currentKey] !== undefined && inner[currentKey] !== null) return inner[currentKey];
            }
        }
        return defaultVal;
    } catch (e) { return defaultVal; }
}

// DEM globals
var dem = ee.Image('USGS/SRTMGL1_003');
var slope = ee.Terrain.slope(dem);

// SAGE Egypt - Main App Controller
// Handles UI rendering, mode switching, and EE computation orchestration

var currentMode = 'welcome';
window.mapClickEnabled = false;

// ====== Panel Management ======
function showPanel() {
    document.getElementById('sidePanel').classList.remove('hidden');
}

function hidePanel() {
    document.getElementById('sidePanel').classList.add('hidden');
    setActiveTab('tbMap');
}

function togglePanel() {
    var panel = document.getElementById('sidePanel');
    panel.classList.toggle('hidden');
}

function setPanelTitle(title) {
    document.getElementById('panelTitle').textContent = title;
}

function setPanelContent(html) {
    document.getElementById('panelBody').innerHTML = html;
}

function setActiveTab(id) {
    document.querySelectorAll('.toolbar-btn').forEach(function (btn) {
        btn.classList.remove('active');
    });
    var el = document.getElementById(id);
    if (el) el.classList.add('active');
}

// ====== Mode Switching ======
function switchMode(mode) {
    currentMode = mode;
    window.mapClickEnabled = false;
    showPanel();

    if (mode === 'farmer') {
        setActiveTab('tbFarmer');
        buildFarmerMode();
    } else if (mode === 'researcher') {
        setActiveTab('tbResearcher');
        buildResearcherMode();
    }
}

// ====== Welcome Screen ======
function showWelcome() {
    currentMode = 'welcome';
    setActiveTab('tbHome');
    showPanel();
    setPanelTitle('ğŸŒ¿ SAGE Egypt');
    setPanelContent(
        '<div class="welcome-screen">' +
        '  <div class="welcome-logo">ğŸŒ¿</div>' +
        '  <h1 class="welcome-title">SAGE Egypt</h1>' +
        '  <p class="welcome-subtitle">Ø§Ù„Ø®Ø¨ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©<br>Smart Agricultural Geo-Expert</p>' +
        '  <button class="btn btn-farmer" onclick="switchMode(\'farmer\')">' +
        '    ğŸŒ¾ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹<span class="btn-desc">ØªÙ‚Ø±ÙŠØ± Ù…Ø¨Ø³Ø· ÙˆØªÙˆØµÙŠØ§Øª Ù„Ù…Ø²Ø±Ø¹ØªÙƒ</span>' +
        '  </button>' +
        '  <button class="btn btn-researcher" onclick="switchMode(\'researcher\')">' +
        '    ğŸŒ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø§Ø­Ø«<span class="btn-desc">ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… ÙˆØ®Ø±Ø§Ø¦Ø· ØªÙØ§Ø¹Ù„ÙŠØ©</span>' +
        '  </button>' +
        '  <div style="margin-top:24px; padding-top:16px; border-top:1px solid #e0e0e0;">' +
        '    <p style="font-size:12px; color:#999;">ğŸ‘¨â€ğŸ”¬ Developer: ELSAYED FAROUK</p>' +
        '    <p style="font-size:11px; color:#bbb;">Faculty of Agriculture, Sohag University</p>' +
        '  </div>' +
        '</div>'
    );
}

// ====== Farmer Mode ======
function buildFarmerMode() {
    setPanelTitle('ğŸŒ¾ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹');

    var crops = [
        '--- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ØµÙˆÙ„ (Select Crop) ---',
        'Ù‚Ù…Ø­ (Wheat)', 'Ø£Ø±Ø² (Rice)', 'Ø°Ø±Ø© (Maize)', 'Ù‚Ø·Ù† (Cotton)',
        'Ø¨Ø·Ø§Ø·Ø³ (Potatoes)', 'Ø·Ù…Ø§Ø·Ù… (Tomato)', 'ÙÙˆÙ„ (Fava Bean)',
        'Ø¨Ø±Ø³ÙŠÙ… (Alfalfa/Clover)', 'Ù‚ØµØ¨ Ø§Ù„Ø³ÙƒØ± (Sugarcane)', 'Ù†Ø®ÙŠÙ„ (Date Palm)',
        'Ø¨Ù†Ø¬Ø± Ø§Ù„Ø³ÙƒØ± (Sugar Beet)', 'ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ (Peanuts)',
        'Ù…ÙˆØ§Ù„Ø­ (Citrus)', 'Ø²ÙŠØªÙˆÙ† (Olive)', 'Ø¹Ù†Ø¨ (Grape)',
        'Ø¨ØµÙ„ (Onion)', 'Ø«ÙˆÙ… (Garlic)', 'ÙÙ„ÙÙ„ (Pepper)',
        'Ø¨Ø§Ø°Ù†Ø¬Ø§Ù† (Eggplant)', 'Ø®ÙŠØ§Ø± (Cucumber)', 'ÙƒÙˆØ³Ø© (Zucchini)',
        'Ù…Ø§Ù†Ø¬Ùˆ (Mango)', 'Ø±Ù…Ø§Ù† (Pomegranate)', 'ØªÙŠÙ† (Fig)',
        'Ù„Ù… Ø£Ø²Ø±Ø¹ Ø¨Ø¹Ø¯ (Not Planted)',
        'Ù…Ø­ØµÙˆÙ„ Ø¢Ø®Ø± (Other)'
    ];

    var cropOptions = crops.map(function (c) {
        return '<option value="' + c + '">' + c + '</option>';
    }).join('');

    setPanelContent(
        // Step 1: Location
        '<div class="card">' +
        '  <div class="card-title">ğŸ“ 1. Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ù…Ø²Ø±Ø¹ØªÙƒ</div>' +
        '  <div class="form-row">' +
        '    <div class="form-group">' +
        '      <label class="form-label">Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶ (Lat)</label>' +
        '      <input type="number" id="fLat" class="form-control" placeholder="26.55" step="any">' +
        '    </div>' +
        '    <div class="form-group">' +
        '      <label class="form-label">Ø®Ø· Ø§Ù„Ø·ÙˆÙ„ (Lng)</label>' +
        '      <input type="number" id="fLng" class="form-control" placeholder="31.69" step="any">' +
        '    </div>' +
        '  </div>' +
        '  <button class="btn btn-outline btn-sm" onclick="enableMapClick()">' +
        '    ğŸ—ºï¸ Ø£Ùˆ Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©' +
        '  </button>' +
        '  <button class="btn btn-outline btn-sm mt-8" onclick="useGPS()">' +
        '    ğŸ“¡ Ø§Ø³ØªØ®Ø¯Ù… GPS' +
        '  </button>' +
        '  <div class="form-group mt-8">' +
        '    <label class="form-label">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ­Ù„ÙŠÙ„ (Ù…ØªØ±)</label>' +
        '    <input type="number" id="fBuffer" class="form-control" value="500" min="100" max="5000">' +
        '  </div>' +
        '</div>' +

        // Step 2: Crop
        '<div class="card">' +
        '  <div class="card-title">ğŸŒ± 2. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ØµÙˆÙ„</div>' +
        '  <div class="form-group">' +
        '    <select id="fCrop" class="form-control">' + cropOptions + '</select>' +
        '  </div>' +
        '</div>' +

        // Step 3: Time
        '<div class="card">' +
        '  <div class="card-title">ğŸ“… 3. ØªÙˆÙ‚ÙŠØª Ø§Ù„ØªØ­Ù„ÙŠÙ„</div>' +
        '  <div class="toggle-row">' +
        '    <span class="toggle-label">âš¡ ØªØ­Ù„ÙŠÙ„ ÙÙˆØ±ÙŠ (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…)</span>' +
        '    <input type="checkbox" id="fRealtime" checked>' +
        '  </div>' +
        '  <div id="fDateRange" class="hidden">' +
        '    <div class="form-row">' +
        '      <div class="form-group">' +
        '        <label class="form-label">Ù…Ù†</label>' +
        '        <input type="date" id="fStartDate" class="form-control" value="2024-01-01">' +
        '      </div>' +
        '      <div class="form-group">' +
        '        <label class="form-label">Ø¥Ù„Ù‰</label>' +
        '        <input type="date" id="fEndDate" class="form-control" value="2024-12-31">' +
        '      </div>' +
        '    </div>' +
        '  </div>' +
        '</div>' +

        // Execute Button
        '<button class="btn btn-execute" onclick="executeFarmerAnalysis()">' +
        '  ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„' +
        '</button>' +

        // Status area
        '<div id="fStatus"></div>'
    );

    // Toggle date range
    document.getElementById('fRealtime').addEventListener('change', function () {
        document.getElementById('fDateRange').classList.toggle('hidden', this.checked);
    });
}

// ====== Map Click Handler ======
function enableMapClick() {
    window.mapClickEnabled = true;
    hidePanel();
    showMapToast('ğŸ“ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ù…Ø²Ø±Ø¹ØªÙƒ');
}

function onMapClick(lat, lng) {
    if (!window.mapClickEnabled) return;
    window.mapClickEnabled = false;

    var latInput = document.getElementById('fLat');
    var lngInput = document.getElementById('fLng');
    if (latInput) latInput.value = lat.toFixed(6);
    if (lngInput) lngInput.value = lng.toFixed(6);

    addMarker(lat, lng, 'ğŸ“ Ù…Ø²Ø±Ø¹ØªÙƒ');
    addBufferCircle(lat, lng, parseInt(document.getElementById('fBuffer').value) || 500);
    centerMap(lat, lng, 15);

    showPanel();
    showMapToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹!');
}

function useGPS() {
    if (!navigator.geolocation) {
        alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS');
        return;
    }
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...');
    navigator.geolocation.getCurrentPosition(
        function (pos) {
            hideLoading();
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;
            document.getElementById('fLat').value = lat.toFixed(6);
            document.getElementById('fLng').value = lng.toFixed(6);
            addMarker(lat, lng, 'ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ');
            centerMap(lat, lng, 15);
            showMapToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ù†Ø¬Ø§Ø­!');
        },
        function (err) {
            hideLoading();
            alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ' + err.message);
        },
        { enableHighAccuracy: true }
    );
}

// ====== Map Toast ======
function showMapToast(msg) {
    var existing = document.getElementById('mapToast');
    if (existing) existing.remove();
    var toast = document.createElement('div');
    toast.id = 'mapToast';
    toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#333;color:white;padding:12px 20px;border-radius:25px;font-size:14px;z-index:200;box-shadow:0 4px 12px rgba(0,0,0,0.3);white-space:nowrap;font-family:Cairo,sans-serif;';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(function () { toast.remove(); }, 3000);
}

// ====== Farmer Analysis Execution ======
function executeFarmerAnalysis() {
    var lat = parseFloat(document.getElementById('fLat').value);
    var lng = parseFloat(document.getElementById('fLng').value);
    var buffer = parseInt(document.getElementById('fBuffer').value) || 500;
    var crop = document.getElementById('fCrop').value;

    // Validation
    if (crop === '--- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ØµÙˆÙ„ (Select Crop) ---') {
        showMapToast('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ØµÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }
    if (isNaN(lat) || isNaN(lng)) {
        showMapToast('âš ï¸ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø£ÙˆÙ„Ø§Ù‹');
        return;
    }
    if (lat < 22 || lat > 32 || lng < 24 || lng > 37) {
        showMapToast('âš ï¸ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø®Ø§Ø±Ø¬ Ø­Ø¯ÙˆØ¯ Ù…ØµØ±!');
    }

    var startDate, endDate;
    if (document.getElementById('fRealtime').checked) {
        var now = new Date();
        var ago = new Date();
        ago.setDate(now.getDate() - 30);
        endDate = now.toISOString().split('T')[0];
        startDate = ago.toISOString().split('T')[0];
    } else {
        startDate = document.getElementById('fStartDate').value;
        endDate = document.getElementById('fEndDate').value;
    }

    // Show loading
    setPanelTitle('ğŸ”¬ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...');
    setPanelContent(
        '<div style="text-align:center; padding:40px 20px;">' +
        '  <div class="spinner" style="margin:0 auto;"></div>' +
        '  <p id="loading-main-text" style="margin-top:16px; font-weight:600; color:#666;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„Ø£Ø±Ø¶ÙŠ...</p>' +
        '  <div id="fStatus" style="min-height:20px; margin-top:10px;"></div>' +
        '  <div style="width:100%; bg:#eee; height:4px; border-radius:2px; margin-top:20px; overflow:hidden;">' +
        '    <div id="loading-progress" style="width:10%; height:100%; background:#4CAF50; transition: width 0.3s;"></div>' +
        '  </div>' +
        '  <p style="font-size:11px; color:#999; margin-top:8px;">Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ù‡Ø°Ø§ 15-30 Ø«Ø§Ù†ÙŠØ©</p>' +
        '</div>'
    );

    addMarker(lat, lng, 'ğŸ“ ' + crop);
    addBufferCircle(lat, lng, buffer);
    centerMap(lat, lng, 15);

    // Create EE geometry
    var farmPoint = ee.Geometry.Point([lng, lat]);
    var farmArea = farmPoint.buffer(buffer);

    // Step 1: Validate location
    var validationStart = startDate;
    var validationEnd = endDate;
    // Use 1 year range for real-time validation
    if (document.getElementById('fRealtime').checked) {
        var yearAgo = new Date();
        yearAgo.setFullYear(yearAgo.getFullYear() - 1);
        validationStart = yearAgo.toISOString().split('T')[0];
    }

    // Safety Timeout: Show "Skip" button if validation hangs for >5s
    var validationTimeout = setTimeout(function () {
        console.warn('Validation slow, offering skip...');
        updateLoadingStatus('âš ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø£Ø·ÙˆÙ„ Ù…Ù† Ø§Ù„Ù…Ø¹ØªØ§Ø¯...');

        // Add Skip Button
        var statusDiv = document.getElementById('fStatus');
        if (statusDiv) {
            statusDiv.innerHTML += '<div style="margin-top:10px;"><button class="btn btn-sm btn-warning" id="btnSkipVal" style="background:#ff9800; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">â© ØªØ®Ø·ÙŠ Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„Ø¨Ø¯Ø¡ ÙÙˆØ±Ø§Ù‹</button></div>';
            document.getElementById('btnSkipVal').onclick = function () {
                clearTimeout(validationTimeout);
                updateLoadingStatus('ğŸš€ ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„ÙØ­ØµØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø¯Ø¡...');
                runFullAnalysis(farmArea, farmPoint, startDate, endDate, crop, lat, lng, buffer, false, false);
            };
        }
    }, 5000);

    // Auto-proceed if it hangs for >15s
    var autoProceedTimeout = setTimeout(function () {
        if (document.getElementById('btnSkipVal')) {
            document.getElementById('btnSkipVal').click();
        }
    }, 15000);

    var validationStats = validateFarmLocation(farmArea, validationStart, validationEnd);
    validationStats.evaluate(function (vResult, vError) {
        clearTimeout(validationTimeout); // Clear timeout if successful
        clearTimeout(autoProceedTimeout);

        if (vError) {
            console.error('Validation error:', vError);
            // Proceed despite validation error
            runFullAnalysis(farmArea, farmPoint, startDate, endDate, crop, lat, lng, buffer, false, false);
            return;
        }

        // In some EE cases the callback returns null/undefined without explicit error.
        // Avoid breaking on property access and continue with full analysis.
        if (!vResult || typeof vResult !== 'object') {
            console.warn('Validation returned empty result, skipping validation gate.');
            runFullAnalysis(farmArea, farmPoint, startDate, endDate, crop, lat, lng, buffer, false, false);
            return;
        }

        function pickNumber(obj, keys, fallback) {
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                if (obj[key] !== undefined && obj[key] !== null && !isNaN(obj[key])) {
                    return Number(obj[key]);
                }
            }
            return fallback;
        }

        // Evaluate validation
        var cropsProb = pickNumber(vResult, ['crops_prob', 'crops'], 0);
        var bareProb = pickNumber(vResult, ['bare_prob', 'bare'], 0);
        var builtProb = pickNumber(vResult, ['built_prob', 'built'], 0);
        var ndviMax = pickNumber(vResult, ['ndvi_max', 'NDVI_max'], 0);
        var ndviMin = pickNumber(vResult, ['ndvi_min', 'NDVI_min'], 0);
        var ndviRange = pickNumber(vResult, ['ndvi_range'], Math.max(0, ndviMax - ndviMin));
        var bsiMean = pickNumber(vResult, ['bsi_mean', 'BSI_mean'], 0);
        var ndbiMean = pickNumber(vResult, ['ndbi_mean', 'NDBI_mean'], 0);
        var albedoMean = pickNumber(vResult, ['albedo_mean', 'Albedo_mean'], 0);
        var ndviStdDev = pickNumber(vResult, ['ndvi_stdDev', 'NDVI_stdDev'], 0);

        // Desert detection
        var desertReasons = [];
        if (ndviMax < 0.15) desertReasons.push('NDVI Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹ (' + ndviMax.toFixed(3) + ')');
        if (bsiMean > 0.05) desertReasons.push('BSI Ù…Ø±ØªÙØ¹ (' + bsiMean.toFixed(3) + ')');
        if (ndviRange < 0.1) desertReasons.push('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¨Ø§ÙŠÙ† Ù…ÙˆØ³Ù…ÙŠ (' + ndviRange.toFixed(3) + ')');
        if (albedoMean > 0.15) desertReasons.push('Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠØ© Ø¹Ø§Ù„ÙŠØ© (' + albedoMean.toFixed(3) + ')');
        if (ndviStdDev < 0.05) desertReasons.push('ØªØ¬Ø§Ù†Ø³ Ù…ÙƒØ§Ù†ÙŠ Ø¹Ø§Ù„ÙŠ (ØµØ­Ø±Ø§Ø¡ Ù…ÙˆØ­Ø¯Ø©)');

        var isDesert = (desertReasons.length >= 3) || (bareProb > 0.6 && ndviMax < 0.2);
        var isUrban = (builtProb > 0.35) || (ndbiMean > 0.1 && builtProb > cropsProb);
        if (isUrban) isDesert = false;

        if (isDesert) {
            showDesertWarning(desertReasons);
        } else if (isUrban) {
            showUrbanWarning(farmArea, farmPoint, startDate, endDate, crop, lat, lng, buffer);
        } else {
            updateLoadingStatus('âœ… Ù…ÙˆÙ‚Ø¹ Ø²Ø±Ø§Ø¹ÙŠ ØµØ§Ù„Ø­ â€” Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...');
            runFullAnalysis(farmArea, farmPoint, startDate, endDate, crop, lat, lng, buffer, false, false);
        }
    });
}

function updateLoadingStatus(msg, percent) {
    var status = document.getElementById('fStatus');
    if (status) status.innerHTML = '<p style="font-size:13px; color:#2E7D32; text-align:center; margin:0;">' + msg + '</p>';

    var mainText = document.getElementById('loading-main-text');
    if (mainText && percent > 20) mainText.textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';

    var progress = document.getElementById('loading-progress');
    if (progress && percent !== undefined) progress.style.width = percent + '%';
}

function showDesertWarning(reasons) {
    setPanelTitle('ğŸœï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù…Ù†Ø·Ù‚Ø© ØµØ­Ø±Ø§ÙˆÙŠØ©');
    var reasonsHTML = reasons.map(function (r) { return '<li style="margin:4px 0;font-size:13px;">' + r + '</li>'; }).join('');
    setPanelContent(
        '<div class="card" style="border-left:4px solid #FF8F00;">' +
        '  <div class="card-title" style="color:#E65100;">ğŸœï¸ Ù…Ù†Ø·Ù‚Ø© ØµØ­Ø±Ø§ÙˆÙŠØ© Ø¬Ø±Ø¯Ø§Ø¡</div>' +
        '  <p style="font-size:13px; color:#555;">Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙŠÙ‚Ø¹ ÙÙŠ Ù…Ù†Ø·Ù‚Ø© ØµØ­Ø±Ø§ÙˆÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„Ø²Ø±Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.</p>' +
        '  <ul style="list-style:none;padding:0;margin:12px 0;color:#666;">' + reasonsHTML + '</ul>' +
        '  <div style="padding:10px;background:#FFF3E0;border-radius:8px;margin-top:12px;">' +
        '    <p style="font-weight:600;color:#E65100;margin-bottom:8px;">ğŸ’¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:</p>' +
        '    <p style="font-size:13px;color:#555;">ğŸ”’ Ø®Ø·Ø© Ø§Ù„Ø§Ø³ØªØµÙ„Ø§Ø­ (Premium)</p>' +
        '  </div>' +
        '</div>' +
        '<button class="btn btn-back" onclick="buildFarmerMode()">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„</button>'
    );
}

function showUrbanWarning(farmArea, farmPoint, startDate, endDate, crop, lat, lng, buffer) {
    setPanelTitle('ğŸ™ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù…Ù†Ø·Ù‚Ø© Ø­Ø¶Ø±ÙŠØ©');
    setPanelContent(
        '<div class="card" style="border-left:4px solid #D32F2F;">' +
        '  <div class="card-title" style="color:#D32F2F;">ğŸ™ï¸ Ù…Ù†Ø·Ù‚Ø© Ø¹Ù…Ø±Ø§Ù†ÙŠØ©/Ù…Ø¨Ø§Ù†ÙŠ</div>' +
        '  <p style="font-size:13px; color:#555;">ØªÙ… Ø±ØµØ¯ Ù…Ù†Ø·Ù‚Ø© Ø¹Ù…Ø±Ø§Ù†ÙŠØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹.</p>' +
        '</div>' +
        '<button class="btn btn-execute" onclick="forceUrbanAnalysis()" style="background:#FF9800;">âš ï¸ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>' +
        '<button class="btn btn-back" onclick="buildFarmerMode()">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>'
    );
    // Store params for force-continue
    window._pendingAnalysis = { farmArea: farmArea, farmPoint: farmPoint, startDate: startDate, endDate: endDate, crop: crop, lat: lat, lng: lng, buffer: buffer };
}

function forceUrbanAnalysis() {
    var p = window._pendingAnalysis;
    if (!p) return;
    setPanelContent(
        '<div style="text-align:center; padding:40px 20px;">' +
        '  <div class="spinner" style="margin:0 auto;"></div>' +
        '  <p style="margin-top:16px; font-weight:600; color:#666;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</p>' +
        '</div>'
    );
    runFullAnalysis(p.farmArea, p.farmPoint, p.startDate, p.endDate, p.crop, p.lat, p.lng, p.buffer, false, true);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FULL ANALYSIS ENGINE (Ported from SAGE_FREE.js runReportLogic)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runFullAnalysis(farmArea, farmPoint, startDate, endDate, cropType, lat, lng, bufferSize, isBarren, isUrban) {
    var isNotPlanted = (cropType.indexOf('Not Planted') > -1 || cropType.indexOf('Ù„Ù… Ø£Ø²Ø±Ø¹') > -1);
    updateLoadingStatus('ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØµÙˆØ± Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© (Sentinel-2)...', 30);

    // Get all data collections
    var s2Col = getS2Collection(startDate, endDate, farmArea);

    s2Col.size().evaluate(function (size) {
        if (size === 0) {
            setPanelTitle('âš ï¸ Ø®Ø·Ø£');
            setPanelContent(
                '<div class="card" style="border-left:4px solid #D32F2F;">' +
                '  <p style="color:#D32F2F;font-weight:600;">Ù„Ø§ ØªØªÙˆÙØ± ØµÙˆØ± Ø£Ù‚Ù…Ø§Ø± ØµÙ†Ø§Ø¹ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©!</p>' +
                '  <p style="font-size:13px;color:#666;">Ø¬Ø±Ø¨ ØªÙˆØ³ÙŠØ¹ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®.</p>' +
                '</div>' +
                '<button class="btn btn-back" onclick="buildFarmerMode()">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>'
            );
            return;
        }

        var s2 = s2Col.median().clip(farmArea);
        window.currentS2Image = s2; // Expose for download handler
        window.currentFarmArea = farmArea;

        // Calculate all indices
        var ndvi = indicesDict['NDVI'](s2);
        var evi = indicesDict['EVI'](s2);
        var savi = indicesDict['SAVI'](s2);
        var gci = indicesDict['GCI'](s2);
        var ndmi = indicesDict['NDMI'](s2);
        var ndwi = indicesDict['NDWI'](s2);
        var ndsi = indicesDict['NDSI'](s2);
        var bsi = indicesDict['BSI'](s2);
        var clayRatio = indicesDict['ClayRatio'](s2);
        var ironOxide = indicesDict['IronOxide'](s2);
        var gypsumIndex = indicesDict['GypsumIndex'](s2);
        var carbonateIndex = indicesDict['CarbonateIndex'](s2);
        var esi = indicesDict['ESI'](s2);
        var si3 = indicesDict['SI3'](s2);

        // Climate data
        var era5 = getEra5(startDate, endDate, farmArea);
        var soilMoisture = era5.select('sm_topsoil_m3m3');
        var rootzoneMoisture = era5.select('sm_rootzone_m3m3');

        // LST from Landsat
        var lsCol = getMergedLandsatCollection(startDate, endDate, farmArea);
        var lstMean = lsCol.select('LST').median();

        // VHI
        var vci = ndvi.unitScale(0, 0.8).multiply(100).clamp(0, 100);
        var tci = ee.Image(100).subtract(lstMean.unitScale(15, 50).multiply(100)).clamp(0, 100);
        var vhi = vci.multiply(0.5).add(tci.multiply(0.5));

        // Climate
        var precip = getChirps(startDate, endDate, farmArea);
        var et = getModisET(startDate, endDate, farmArea);

        // SAR + Salinity
        var s1Col = getS1Collection(startDate, endDate, farmArea);
        var s1 = ee.Algorithms.If(s1Col.size().gt(0),
            s1Col.median().clip(farmArea),
            ee.Image([0, 0]).rename(['VV_smoothed', 'VH_smoothed']));
        s1 = ee.Image(s1);
        var advancedEC = estimateSalinity_ML(s2, s1, lstMean, precip, et, dem, slope);

        updateLoadingStatus('ğŸ›°ï¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±. Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª (20+ Indices)...', 50);

        // Soil data
        var olmImage = getOpenLandMapSoil(farmArea);
        var olmStatsMean = olmImage.select(['Clay_0cm', 'Sand_0cm', 'OC_0cm', 'pH_0cm', 'BulkDens_0cm', 'WC_33kPa'])
            .reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 250, maxPixels: 1e9 });
        var textureMode = olmImage.select('TextureClass')
            .reduceRegion({ reducer: ee.Reducer.mode(), geometry: farmArea, scale: 250, maxPixels: 1e9 });
        var olmSoilProperties = olmStatsMean.combine(textureMode);

        updateLoadingStatus('ğŸ”ï¸ Ø¬Ø§Ø±ÙŠ Ø¯Ù…Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø¨Ø© ÙˆØ§Ù„Ù…Ù†Ø§Ø® (OpenLandMap & ERA5)...', 70);

        // Compile statistics
        var stats = ee.Dictionary({
            ndvi: ndvi.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            evi: evi.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            savi: savi.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            gci: gci.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            ndmi: ndmi.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            ndwi: ndwi.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            ndsi: ndsi.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            bsi: bsi.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            clayRatio: clayRatio.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            ironOxide: ironOxide.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            gypsumIndex: gypsumIndex.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            carbonateIndex: carbonateIndex.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            esi: esi.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            si3: si3.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            ec_dsm: advancedEC.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 10, maxPixels: 1e9 }),
            sm: soilMoisture.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 11132, maxPixels: 1e9 }),
            smRoot: rootzoneMoisture.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 11132, maxPixels: 1e9 }),
            lst: lstMean.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 30, maxPixels: 1e9 }),
            vhi: vhi.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 30, maxPixels: 1e9 }),
            precip: precip.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 5566, maxPixels: 1e9 }),
            et: et.reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 500, maxPixels: 1e9 }),
            rh: era5.select('RH').reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 11132, maxPixels: 1e9 }),
            airTemp: era5.select('air_temp_C').reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 11132, maxPixels: 1e9 }),
            windSpeed: era5.select('WindSpeed').reduceRegion({ reducer: ee.Reducer.mean(), geometry: farmArea, scale: 11132, maxPixels: 1e9 }),
            olmSoil: olmSoilProperties,
            currentMonth: ee.Number(ee.Date(endDate).get('month'))
        });

        // NDVI Time Series for Chart (Optimized)
        var ndviTimeSeries = s2Col.map(function (img) {
            var mean = indicesDict['NDVI'](img).reduceRegion({
                reducer: ee.Reducer.mean(),
                geometry: farmPoint, // Use point for chart speed
                scale: 10,
                maxPixels: 1e8
            });
            return ee.Feature(null, { NDVI: mean.get('NDVI'), date: img.date().format('YYYY-MM-dd') });
        });

        updateLoadingStatus('ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©...', 90);

        // Safety Timeout for full analysis evaluation
        var analysisTimeout = setTimeout(function () {
            updateLoadingStatus('âš ï¸ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹ØŒ Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø±Ø¶...', 95);
        }, 30000);

        // Evaluate all at once
        stats.evaluate(function (result, error) {
            clearTimeout(analysisTimeout);
            if (error) {
                setPanelTitle('âš ï¸ Ø®Ø·Ø£');
                setPanelContent('<div class="card"><p style="color:red;">' + error + '</p></div><button class="btn btn-back" onclick="buildFarmerMode()">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>');
                return;
            }
            if (!result) {
                setPanelTitle('âš ï¸ Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª');
                setPanelContent('<div class="card"><p>Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹</p></div><button class="btn btn-back" onclick="buildFarmerMode()">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>');
                return;
            }

            // Get time series then render
            ndviTimeSeries.aggregate_array('NDVI').evaluate(function (ndviArr) {
                ndviTimeSeries.aggregate_array('date').evaluate(function (dateArr) {
                    renderFullReport(result, cropType, lat, lng, bufferSize, startDate, endDate,
                        ndviArr || [], dateArr || [], isBarren, isUrban, isNotPlanted);
                });
            });
        });

        // Add NDVI layer to map
        addEELayer(ndvi, { min: -0.1, max: 0.8, palette: ['red', 'yellow', 'green', 'darkgreen'] }, 'NDVI');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FULL FARMER REPORT (All Sections)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFullReport(result, cropType, lat, lng, bufferSize, startDate, endDate, ndviArr, dateArr, isBarren, isUrban, isNotPlanted) {
    // Extract all values using safeGet
    var ndviVal = safeGet(result, 'ndvi', 'NDVI', 0);
    var eviVal = safeGet(result, 'evi', 'EVI', 0);
    var saviVal = safeGet(result, 'savi', 'SAVI', 0);
    var ndmiVal = safeGet(result, 'ndmi', 'NDMI', 0);
    var ndsiVal = safeGet(result, 'ndsi', 'NDSI', 0);
    var esiVal = safeGet(result, 'esi', 'ESI', 0.5);
    var si3Val = safeGet(result, 'si3', 'SI3', 0.1);
    var vhiVal = safeGet(result, 'vhi', 'VCI', 50);
    var rhVal = safeGet(result, 'rh', 'RH', 40);
    var airTempVal = safeGet(result, 'airTemp', 'air_temp_C', 25);
    var windSpeedVal = safeGet(result, 'windSpeed', 'WindSpeed', 3);
    var bsiVal = safeGet(result, 'bsi', 'BSI', 0);
    var smVal = safeGet(result, 'sm', 'sm_topsoil_m3m3', null);
    var lstVal = safeGet(result, 'lst', 'LST', 30);
    var etVal = safeGet(result, 'et', 'ET', 5);
    var precipVal = safeGet(result, 'precip', 'Precipitation', 0);

    // EC Real
    var ecRealVal = safeGet(result, 'ec_dsm', 'EC_dSm', -1);
    if (ecRealVal <= 1.05 && ndsiVal > 0.25 && ndviVal < 0.20 && bsiVal > 0.05) {
        ecRealVal = 10.0 + (ndsiVal * 20);
    }
    if (ecRealVal < 0) ecRealVal = 1.0;
    var csiVal = Math.min(1, ecRealVal / 10);

    // Soil data
    var olmClay = safeGet(result, 'olmSoil', 'Clay_0cm', null);
    var olmSand = safeGet(result, 'olmSoil', 'Sand_0cm', null);
    var olmOC = safeGet(result, 'olmSoil', 'OC_0cm', null);
    var olmPH = safeGet(result, 'olmSoil', 'pH_0cm', null);
    var olmBulkDens = safeGet(result, 'olmSoil', 'BulkDens_0cm', null);
    var olmTextureRaw = safeGet(result, 'olmSoil', 'TextureClass', null);
    var hasRealSoilData = (olmClay !== null && olmSand !== null);

    // USDA Texture classification
    var olmSilt = hasRealSoilData ? (100 - olmClay - olmSand) : null;
    if (olmSilt !== null && olmSilt < 0) olmSilt = 0;
    var olmTexture, soilSource;
    if (hasRealSoilData) {
        olmTexture = classifyUSDATexture(olmClay, olmSand);
        soilSource = 'ğŸ”¬ USDA (Clay=' + olmClay.toFixed(0) + '%, Sand=' + olmSand.toFixed(0) + '%)';
    } else if (olmTextureRaw) {
        olmTexture = textureClassNames[Math.round(olmTextureRaw)] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        soilSource = 'ğŸ“¡ OpenLandMap';
    } else {
        olmTexture = 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        soilSource = 'âš ï¸ Ù„Ø§ ØªØªÙˆÙØ± Ø¨ÙŠØ§Ù†Ø§Øª';
    }

    var isLiveBarren = (ndviVal < 0.20) || (bsiVal > 0.25);
    var isInvalidForCrop = isBarren || isUrban || isLiveBarren;
    var currentMonth = (result.currentMonth !== undefined) ? result.currentMonth : (new Date().getMonth() + 1);

    // Compute all recommendations
    var salinity = classifySalinity(ecRealVal);
    var traffic = getTrafficLight(ecRealVal, ndviVal, bsiVal);

    // Moisture composite
    var ndmiNorm = Math.min(1, Math.max(0, (ndmiVal + 0.2) / 0.6));
    var smUsed = smVal !== null ? smVal : 0.2;
    var smNorm = Math.min(1, Math.max(0, (smUsed - 0.05) / 0.35));
    var compositeMoisture = (ndmiNorm * 0.4) + (smNorm * 0.6);
    var droughtRiskVal = 1 - compositeMoisture;

    var healthScore = calculateHealthScore(ndviVal, vhiVal, csiVal, droughtRiskVal, isInvalidForCrop);
    var healthStatus = isInvalidForCrop ? 'Ø£Ø±Ø¶ ØºÙŠØ± Ù…Ø³ØªØºÙ„Ø©' : (healthScore > 75 ? 'Ù…Ù…ØªØ§Ø²Ø©' : (healthScore > 55 ? 'Ø¬ÙŠØ¯Ø©' : (healthScore > 35 ? 'Ù…ØªÙˆØ³Ø·Ø©' : 'Ø¶Ø¹ÙŠÙØ©')));
    var healthColor = isInvalidForCrop ? '#D2691E' : (healthScore > 75 ? '#2E7D32' : (healthScore > 55 ? '#43A047' : (healthScore > 35 ? '#F57C00' : '#D32F2F')));

    var dateStr = new Date().toISOString().split('T')[0];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUILD HTML REPORT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    var html = '<button class="btn btn-back mb-16" onclick="buildFarmerMode()">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„</button>';

    // Header
    html += '<div class="report-header" style="text-align:center;padding:16px;background:linear-gradient(135deg,#1B5E20,#388E3C);color:white;border-radius:12px;margin-bottom:12px;">' +
        '<h2 style="margin:0;font-size:20px;">ğŸŒ¾ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ</h2></div>';

    // Info box
    html += '<div class="card" style="background:#E8F5E9;">' +
        '<div style="font-size:13px;">ğŸ“ ' + lat.toFixed(4) + 'Â°N, ' + lng.toFixed(4) + 'Â°E</div>' +
        '<div style="font-size:13px;">ğŸŒ± Ø§Ù„Ù…Ø­ØµÙˆÙ„: ' + cropType + '</div>' +
        '<div style="font-size:12px;color:#1565C0;margin-top:6px;">ğŸ“… ' + dateStr + ' | ğŸ›°ï¸ ' + startDate + ' â†’ ' + endDate + '</div>' +
        '</div>';

    // Traffic Light
    html += '<div style="text-align:center;padding:12px;background:' + traffic.bg + ';border-radius:10px;margin:8px 0;">' +
        '<span style="font-weight:700;font-size:15px;color:' + traffic.color + ';">' + traffic.label + '</span></div>';

    // Irrigation note
    var irrig = calculateIrrigation(olmTexture, lstVal, windSpeedVal, currentMonth, ecRealVal, olmSand, olmClay);
    html += '<div style="font-size:12px;font-weight:600;color:#0277BD;background:#E0F7FA;padding:10px;border-radius:8px;margin:6px 0;">' + irrig.note + '</div>';

    // â•â•â• 1. Overall Status â•â•â•
    html += cardTitle('ğŸ¯', isInvalidForCrop ? 'Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø±Ø¶' : 'Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ø­ØµÙˆÙ„');
    html += statRow('Ù…Ø¤Ø´Ø± Ø§Ù„ØµØ­Ø©:', isInvalidForCrop ? '---' : healthScore.toFixed(0) + '%', healthColor, healthStatus);
    html += statRow('ğŸ”ï¸ Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø¨Ø©:', olmTexture, '#1976D2', soilSource);

    // â•â•â• 2. Fertilizer Recommendations â•â•â•
    if (!isInvalidForCrop) {
        html += cardTitle('ğŸ§ª', 'ØªÙˆØµÙŠØ§Øª Ø§Ù„ØªØ³Ù…ÙŠØ¯ (Ù…Ø®ØµØµ Ù„Ù„Ù…Ø­ØµÙˆÙ„)');
        var fert = getFertilizerRec(cropType, olmOC, olmPH, olmTexture);
        html += statRow('Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ† (N):', fert.N + ' ÙˆØ­Ø¯Ø©/ÙØ¯Ø§Ù†', '#1B5E20', 'Ø£Ø¶Ù ' + fert.urea + ' ÙƒØ¬Ù… ÙŠÙˆØ±ÙŠØ§ (' + fert.note + ')');
        html += statRow('Ø§Ù„ÙÙˆØ³ÙÙˆØ± (P):', fert.P + ' ÙˆØ­Ø¯Ø©/ÙØ¯Ø§Ù†', '#F57F17', 'Ø£Ø¶Ù ' + fert.superPhosphate + ' ÙƒØ¬Ù… Ø³ÙˆØ¨Ø± ÙÙˆØ³ÙØ§Øª');
        html += statRow('Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (K):', fert.K + ' ÙˆØ­Ø¯Ø©/ÙØ¯Ø§Ù†', '#7B1FA2', 'Ø£Ø¶Ù ' + fert.potassiumSulfate + ' ÙƒØ¬Ù… Ø³Ù„ÙØ§Øª Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…');

        // Expert phenology note
        var expertNote = getExpertNote(cropType, currentMonth);
        if (expertNote) {
            html += '<div style="font-size:13px;color:#1B5E20;font-style:italic;background:#F1F8E9;padding:8px;border:1px solid #C5E1A5;border-radius:6px;margin:6px 0;">' + expertNote + '</div>';
        }
        if (lstVal > 35) {
            html += '<div style="font-size:13px;color:#E65100;background:#FFF3E0;padding:8px;border-radius:6px;margin:6px 0;">âš ï¸ Ø¥Ø¬Ù‡Ø§Ø¯ Ø­Ø±Ø§Ø±ÙŠ: Ù„Ø§ ØªØ±ÙˆÙ ÙÙŠ ÙˆÙ‚Øª Ø§Ù„Ø¸Ù‡ÙŠØ±Ø©!</div>';
        }
    }

    // â•â•â• 3. Pest & Disease Risk â•â•â•
    html += cardTitle('ğŸ›', 'Ø±ØµØ¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø± Ø§Ù„Ø­ÙŠÙˆÙŠØ© (Ù…Ù†Ø§Ø® Ø¯Ù‚ÙŠÙ‚)');
    html += statRow('ğŸŒªï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ùˆ:', 'Ø±Ø·ÙˆØ¨Ø©: ' + rhVal.toFixed(0) + '% | Ø­Ø±Ø§Ø±Ø©: ' + airTempVal.toFixed(1) + 'Â°Ù…', '#333');
    var pest = assessPestRisk(cropType, rhVal, airTempVal);
    html += statRow('ğŸ¦  ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø£Ù…Ø±Ø§Ø¶:', pest.risk, pest.color);
    if (pest.color !== 'green') {
        html += '<div style="font-size:13px;color:#D32F2F;margin:4px 8px;font-weight:600;">ğŸ’¡ ' + pest.msg + '</div>';
    }

    // â•â•â• 4. Salinity & Crop Tolerance â•â•â•
    var tolerance = checkCropSalinityTolerance(cropType, csiVal);
    if (!tolerance.compatible) {
        html += '<div style="font-weight:700;font-size:16px;color:white;background:#D32F2F;padding:12px;margin:10px 0;border-radius:8px;text-align:center;">â›” ØªØ­Ø°ÙŠØ±: ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚!</div>';
        html += '<div style="font-size:13px;color:#D32F2F;padding:4px 8px;">Ù…Ø­ØµÙˆÙ„ "' + cropType + '" Ù„Ø§ ÙŠØªØ­Ù…Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ø£Ù…Ù„Ø§Ø­.</div>';
        html += '<div style="font-size:13px;color:green;font-weight:600;padding:4px 8px;">ğŸ’¡ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹ÙŠØ± Ø£Ùˆ Ø§Ù„Ø¨Ù†Ø¬Ø± Ø£Ùˆ Ø§Ù„Ù†Ø®ÙŠÙ„.</div>';
    } else if (tolerance.classIndex > 0) {
        html += '<div style="font-size:13px;color:#F57C00;padding:4px 8px;">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù„ÙˆØ­Ø©: Ø§Ù„ØªØ±Ø¨Ø© Ø¨Ù‡Ø§ Ù…Ù„ÙˆØ­Ø© ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…Ø­ØµÙˆÙ„ ÙŠØªØ­Ù…Ù„Ù‡Ø§.</div>';
    }

    // â•â•â• 5. Operations Manager â•â•â•
    html += cardTitle('ğŸšœ', 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©');

    // Spraying
    var spray = assessSprayConditions(windSpeedVal, airTempVal);
    html += statRow('ğŸš¿ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø±Ø´:', spray.canSpray ? 'Ù…Ø³Ù…ÙˆØ­ âœ…' : 'Ù…Ù…Ù†ÙˆØ¹ â›”', spray.color, spray.msg);

    // Yield
    if (!isInvalidForCrop && !isNotPlanted) {
        var yieldEst = estimateYield_Simple(ndviVal, cropType);
        html += statRow('âš–ï¸ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:', yieldEst.text, '#2E7D32', yieldEst.status);
    }

    // â•â•â• 6. Irrigation Scheduler â•â•â•
    if (!isInvalidForCrop) {
        html += cardTitle('ğŸš¿', 'Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±ÙŠ Ø§Ù„Ø°ÙƒÙŠ');
        html += statRow('Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø¨Ø©:', irrig.soilTypeAr, '#333');
        html += statRow('ğŸ•’ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­:', 'ÙƒÙ„ ' + irrig.interval + ' Ø£ÙŠØ§Ù…', '#0097A7', 'ÙÙŠ Ø§Ù„Ø¸Ø±ÙˆÙ Ø§Ù„Ø­Ø§Ù„ÙŠØ©');
        html += statRow('ğŸ’§ ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ÙŠØ§Ù‡:', irrig.waterAmount, '#333');
        if (droughtRiskVal > 0.6) {
            html += '<div style="font-size:13px;color:red;padding:4px 8px;">âš ï¸ Ø§Ù„Ø£Ø±Ø¶ Ø¬Ø§ÙØ© Ø¬Ø¯Ø§Ù‹! Ù‚Ù„Ù‘Ù„ Ø§Ù„ÙØªØ±Ø© Ø¨Ù…Ù‚Ø¯Ø§Ø± ÙŠÙˆÙ….</div>';
        }
    }

    // â•â•â• 7. Leaching Requirement â•â•â•
    if (!isInvalidForCrop && ecRealVal > 2.0 && !isNotPlanted) {
        html += cardTitle('ğŸš¿', 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙˆØ­Ø© ÙˆØºØ³ÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø©');
        html += '<div style="font-size:12px;font-weight:600;color:#D32F2F;padding:4px 8px;">Ù…Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±Ø¨Ø©: ' + ecRealVal.toFixed(1) + ' dS/m</div>';
        var leach = calculateLeachingReq(ecRealVal, cropType);
        html += statRow('ğŸ’§ ' + leach.nile.label + ':', 'Ø²ÙŠØ§Ø¯Ø© ' + leach.nile.minutes + ' Ø¯Ù‚ÙŠÙ‚Ø©/Ø³Ø§Ø¹Ø©', 'blue', 'Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙ…Ù„Ø­');
        html += statRow('ğŸ’§ ' + leach.well.label + ':', 'Ø²ÙŠØ§Ø¯Ø© ' + leach.well.minutes + ' Ø¯Ù‚ÙŠÙ‚Ø©/Ø³Ø§Ø¹Ø©', '#F9A825', 'Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙ…Ù„Ø­');
        if (leach.saline.impossible) {
            html += statRow('ğŸ’§ ' + leach.saline.label + ':', 'ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨ âŒ', 'red', 'Ø®Ø·Ø± ØªÙ…Ù„Ø­ Ø´Ø¯ÙŠØ¯');
        } else {
            html += statRow('ğŸ’§ ' + leach.saline.label + ':', 'Ø²ÙŠØ§Ø¯Ø© ' + leach.saline.minutes + ' Ø¯Ù‚ÙŠÙ‚Ø©/Ø³Ø§Ø¹Ø©', 'red', 'Ø­Ø°Ø± Ø´Ø¯ÙŠØ¯');
        }
        html += '<div style="font-size:13px;color:#333;padding:6px 8px;">ğŸ“ Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø© Ø±ÙŠ Ø¹Ø§Ø¯ÙŠØ©ØŒ Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ù„ØºØ³ÙŠÙ„ Ø§Ù„Ø£Ù…Ù„Ø§Ø­.</div>';
    }

    // â•â•â• 8. Warnings â•â•â•
    html += cardTitle('âš ï¸', 'Ø§Ù„ØªØ­Ø°ÙŠØ±Ø§Øª Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©');
    var droughtLabel = droughtRiskVal > 0.6 ? 'ğŸ”´ Ù…Ø±ØªÙØ¹' : (droughtRiskVal > 0.3 ? 'ğŸŸ  Ù…ØªÙˆØ³Ø·' : 'âœ… Ù…Ù†Ø®ÙØ¶');
    var droughtColor = droughtRiskVal > 0.6 ? 'red' : (droughtRiskVal > 0.3 ? 'orange' : 'green');
    html += statRow('ğŸ’§ Ø®Ø·Ø± Ø§Ù„Ø¬ÙØ§Ù:', droughtLabel, droughtColor);
    var irrAction = droughtRiskVal > 0.6 ? 'âš ï¸ Ø±ÙŠ Ø¹Ø§Ø¬Ù„ Ù…ÙƒØ«Ù' : (droughtRiskVal > 0.3 ? 'ğŸŸ¡ Ø±ÙŠ ØªÙƒÙ…ÙŠÙ„ÙŠ' : 'âœ… Ø±ÙŠ Ù…Ø³ØªÙ‚Ø±');
    html += statRow('ğŸš¿ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø±ÙŠ:', irrAction, droughtColor);
    html += statRow('ğŸ§‚ Ù…Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±Ø¨Ø© (EC):', ecRealVal.toFixed(1) + ' dS/m', ecRealVal > 8 ? 'red' : (ecRealVal > 4 ? 'orange' : 'green'));
    html += statRow('ğŸŒ¡ï¸ Ø­Ø±Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨Ø©:', lstVal.toFixed(1) + 'Â°C', lstVal > 38 ? 'orange' : 'green');

    // â•â•â• 9. NDVI Chart â•â•â•
    html += '<div class="card"><div class="card-title">ğŸ“ˆ ØªØ·ÙˆØ± Ø§Ù„ØºØ·Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§ØªÙŠ</div>' +
        '<div class="chart-container"><canvas id="ndviChart"></canvas></div></div>';

    // â•â•â• 10. Detailed Soil Report (PREMIUM) â•â•â•
    html += '<div class="card" style="border: 1px solid #ddd; background: #fff;">' +
        '  <div style="background: #f0f0f0; padding: 10px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between;" onclick="togglePremiumSection(\'soil-report-detail\')">' +
        '    <span>ğŸ”ï¸ 8. ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</span>' +
        '    <span id="soil-report-detail-icon">â–¸</span>' +
        '  </div>' +
        '  <div id="soil-report-detail" style="display: none; padding: 10px; border-top: 1px solid #eee; font-size: 13px;">';

    // Soil Data Content
    html += '<div style="font-weight: 700; border-bottom: 2px solid #4CAF50; margin-bottom: 10px; padding-bottom: 4px;">ğŸ”ï¸ Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø¨Ø© Ø§Ù„Ù…ÙƒØªØ´Ù</div>';
    var unifiedTexture = classifyUSDATexture(olmClay || 0, olmSand || 0);
    html += '<div style="margin: 5px 0;"><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ' + unifiedTexture + '</div>';

    if (olmClay !== null) {
        html += '<div style="background: #f9f9f9; padding: 8px; border-radius: 6px; margin: 10px 0;">' +
            '  <div style="font-weight: 700; margin-bottom: 6px;">ğŸ“Š Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¦ÙŠØ©:</div>' +
            '  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">' +
            '    <span>ğŸ§± Ø·ÙŠÙ†: ' + olmClay.toFixed(1) + '%</span>' +
            '    <span>ğŸ–ï¸ Ø±Ù…Ù„: ' + olmSand.toFixed(1) + '%</span>' +
            '    <span>ğŸŒ¾ Ø³Ù„Øª: ' + (100 - olmClay - olmSand).toFixed(1) + '%</span>' +
            '    <span>âš—ï¸ pH: ' + (olmPH ? olmPH.toFixed(1) : 'Ù†/Ø£') + '</span>' +
            '  </div>' +
            '</div>';
    }

    // Expert Recommendations
    html += '<div style="font-weight: 700; color: #2E7D32; margin-top: 15px;">ğŸ“‹ Ø®Ø·Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªØ±Ø¨Ø© (Expert Fixes):</div>';
    var soilRecs = [];
    if (csiVal > 0.3) {
        var gypsumTons = (csiVal * 4).toFixed(1);
        soilRecs.push('â€¢ Ø¥Ø¶Ø§ÙØ© ' + gypsumTons + ' Ø·Ù†/ÙØ¯Ø§Ù† Ø¬Ø¨Ø³ Ø²Ø±Ø§Ø¹ÙŠ');
        soilRecs.push('â€¢ ØºØ³ÙŠÙ„ Ø§Ù„ØªØ±Ø¨Ø© Ø¨Ù…ÙŠØ§Ù‡ Ø¹Ø°Ø¨Ø©');
    }
    if (olmPH > 8.2) {
        soilRecs.push('â€¢ Ø¥Ø¶Ø§ÙØ© 200 ÙƒØ¬Ù… ÙƒØ¨Ø±ÙŠØª Ø²Ø±Ø§Ø¹ÙŠ Ø®Ø´Ù†');
        soilRecs.push('â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø³Ù…Ø¯Ø© Ø­Ø§Ù…Ø¶ÙŠØ© (Ø³Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø§Ø¯Ø±)');
    }
    if (soilRecs.length === 0) soilRecs.push('âœ… Ø§Ù„ØªØ±Ø¨Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø© Ù…Ø³ØªÙ‚Ø±Ø©.');

    soilRecs.forEach(function (rec) {
        html += '<div style="margin: 4px 0; font-weight: 600;">' + rec + '</div>';
    });

    html += '  </div>' +
        '</div>';

    // â•â•â• 11. Suggested Crops (PREMIUM) â•â•â•
    html += '<div class="card" style="border: 1px solid #ddd; background: #fff;">' +
        '  <div style="background: #e8f5e9; padding: 10px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between;" onclick="togglePremiumSection(\'crop-suggestions\')">' +
        '    <span>ğŸŒ½ 9. Ø§Ù„Ù…Ø­Ø§ØµÙŠÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</span>' +
        '    <span id="crop-suggestions-icon">â–¸</span>' +
        '  </div>' +
        '  <div id="crop-suggestions" style="display: none; padding: 10px; border-top: 1px solid #eee; font-size: 13px;">';

    var recs = [];
    if (ecRealVal > 8) recs.push('ğŸŒ¾ Ø´Ø¹ÙŠØ± (Barley)');
    if (ecRealVal > 7) recs.push('ğŸ¬ Ø¨Ù†Ø¬Ø± Ø§Ù„Ø³ÙƒØ± (Sugar Beet)');
    if (ecRealVal > 6) recs.push('ğŸŒ´ Ù†Ø®ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø­ (Date Palm)');
    if (ecRealVal <= 6 && ecRealVal > 2) recs.push('ğŸ Ù‚Ù…Ø­ (Wheat)');
    if (ecRealVal < 4) recs.push('ğŸ… Ø·Ù…Ø§Ø·Ù… (Tomato)');
    if (ecRealVal < 2) recs.push('ğŸŒ½ Ø°Ø±Ø© (Maize)');

    if (olmSand > 70) recs.push('ğŸ¥œ ÙÙˆÙ„ Ø³ÙˆØ¯Ø§Ù†ÙŠ (Peanuts)');
    if (olmSand > 60) recs.push(' potatoes (Ø¨Ø·Ø§Ø·Ø³)');
    if (olmSand > 50) recs.push('ğŸ‰ Ø¨Ø·ÙŠØ® (Watermelon)');
    if (olmClay > 35) recs.push('ğŸ‘• Ù‚Ø·Ù† (Cotton)');
    if (olmClay > 40) recs.push('ğŸš Ø£Ø±Ø² (Rice)');

    recs = [...new Set(recs)]; // Distinct
    recs.forEach(function (r) {
        html += '<div style="background:#F1F8E9; padding:6px; border-radius:6px; margin:3px 0; border-right:3px solid #4CAF50;">' + r + '</div>';
    });

    if (olmPH > 8.0) {
        html += '<div style="color:#D32F2F; margin-top:10px; font-weight:bold;">âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ù„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ© - ÙŠÙ†ØµØ­ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¨Ø³ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ</div>';
    }

    html += '  </div>' +
        '</div>';

    // â•â•â• 12. Desert Reclamation Plan (PREMIUM) â•â•â•
    html += '<div class="card" style="border: 1px solid #ddd; background: #fff;">' +
        '  <div style="background: #FFF3E0; padding: 10px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between;" onclick="togglePremiumSection(\'reclamation-plan\')">' +
        '    <span>ğŸšœ 10. Ø®Ø·Ø© Ø§Ø³ØªØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø±Ø§Ø¶ÙŠ</span>' +
        '    <span id="reclamation-plan-icon">â–¸</span>' +
        '  </div>' +
        '  <div id="reclamation-plan" style="display: none; padding: 10px; border-top: 1px solid #eee; font-size: 13px;">' +
        '    <div style="color:#E65100; font-weight:bold; margin-bottom:5px;">ğŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ø§Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£ÙˆÙ„ÙŠ (3-6 Ø£Ø´Ù‡Ø±)</div>' +
        '    <div>â€¢ ØªØ­Ù„ÙŠÙ„ ØªØ±Ø¨Ø© Ù…Ø®Ø¨Ø±ÙŠ Ø´Ø§Ù…Ù„</div>' +
        '    <div>â€¢ ØªØ³ÙˆÙŠØ© Ø§Ù„Ø£Ø±Ø¶ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„ØµØ®ÙˆØ±</div>' +
        '    <div>â€¢ Ø­ÙØ± Ø¨Ø¦Ø± Ø£Ùˆ ØªÙˆØµÙŠÙ„ Ù…ØµØ¯Ø± Ù…ÙŠØ§Ù‡</div>' +
        '    <div style="color:#E65100; font-weight:bold; margin:10px 0 5px 0;">ğŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ±Ø¨Ø© (6-12 Ø´Ù‡Ø±)</div>' +
        '    <div>â€¢ Ø¥Ø¶Ø§ÙØ© 20-30 Ù…Â³/ÙØ¯Ø§Ù† Ø³Ù…Ø§Ø¯ Ø¨Ù„Ø¯ÙŠ Ù…ØªØ­Ù„Ù„</div>' +
        '    <div>â€¢ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¨Ø³ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ Ø£Ùˆ Ø§Ù„ÙƒØ¨Ø±ÙŠØª</div>' +
        '    <div>â€¢ Ø­Ø±Ø« Ø¹Ù…ÙŠÙ‚ (40-60 Ø³Ù…) ÙˆØªÙ‚Ù„ÙŠØ¨</div>' +
        '    <div style="color:#D32F2F; font-weight:bold; margin-top:10px;">ğŸ’° Ø§Ù„ØªÙƒÙ„ÙØ©: 15,000 - 25,000 Ø¬/ÙØ¯Ø§Ù†</div>' +
        '  </div>' +
        '</div>';

    // â•â•â• 12. Notes â•â•â•
    html += '<div style="padding:10px;background:#f5f5f5;border-radius:8px;margin:10px 0;font-size:12px;color:#777;">' +
        'ğŸ“ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ ØµÙˆØ± Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©. Ø¯Ù‚Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª: 70-90%.</div>';

    // â•â•â• Map Export â•â•â•
    html += '<button id="btn-download-map" class="btn" style="width:100%;background:#607D8B;color:white;margin:8px 0;padding:10px;" onclick="downloadFarmMap()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø²Ø±Ø¹Ø© (Download Map)</button>';

    setPanelTitle('ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ (Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø©)');
    setPanelContent(html);

    // Draw chart
    if (dateArr && dateArr.length > 0) {
        setTimeout(function () {
            var ctx = document.getElementById('ndviChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dateArr,
                        datasets: [{
                            label: 'NDVI',
                            data: ndviArr,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76,175,80,0.1)',
                            fill: true, tension: 0.3, pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { min: 0, max: 1, title: { display: true, text: 'NDVI' } },
                            x: { ticks: { maxTicksToAutoSkip: true, maxRotation: 45 } }
                        }
                    }
                });
            }
        }, 200);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HTML HELPER FUNCTIONS (Report UI Components)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function cardTitle(emoji, title) {
    return '<div style="font-weight:700;font-size:15px;color:#333;background:#f0f0f0;padding:10px;text-align:center;margin:14px 0 6px 0;border:1px solid #ddd;border-radius:8px;">' +
        emoji + ' ' + title + '</div>';
}

function statRow(name, value, color, note) {
    var html = '<div style="display:flex;align-items:center;padding:6px 8px;margin:3px 0;background:#f9f9f9;border-radius:6px;gap:8px;">' +
        '<span style="font-size:13px;font-weight:600;flex:1;">' + name + '</span>' +
        '<span style="font-size:14px;font-weight:700;color:' + (color || '#333') + ';">' + value + '</span>';
    if (note) html += '<span style="font-size:11px;color:#888;font-style:italic;max-width:140px;">' + note + '</span>';
    html += '</div>';
    return html;
}

// ====== Researcher Mode Implementation ======
function buildResearcherMode() {
    setPanelTitle('ğŸŒ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø§Ø­Ø« (Researcher Mode)');

    var html = '<div class="card">' +
        '  <div class="card-title">1) Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</div>' +
        '  <p style="font-size:12px;color:#666;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø£Ùˆ Ø§Ø±Ø³Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø§Ø³Ø©:</p>' +
        '  <select id="gov-select" class="form-select" style="width:100%;margin-bottom:10px;" onchange="handleGovChange()">' +
        '    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© --</option>' +
        '  </select>' +
        '</div>';

    html += '<div class="card">' +
        '  <div class="card-title">2) Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø³ØªØ´Ø¹Ø±</div>' +
        '  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">' +
        '    <div style="font-size:12px;">Ù…Ù†:<input type="date" id="research-start" value="2024-01-01" style="width:100%;"></div>' +
        '    <div style="font-size:12px;">Ø¥Ù„Ù‰:<input type="date" id="research-end" value="2024-12-31" style="width:100%;"></div>' +
        '  </div>' +
        '  <select id="sensor-select" class="form-select" style="width:100%;">' +
        '    <option value="Sentinel-2">Sentinel-2 (10m)</option>' +
        '    <option value="Landsat 8">Landsat 8 (30m)</option>' +
        '    <option value="Landsat 7">Landsat 7 (30m)</option>' +
        '    <option value="Landsat 5">Landsat 5 (30m)</option>' +
        '  </select>' +
        '</div>';

    html += '<div class="card">' +
        '  <div class="card-title">3) ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª (Indices)</div>' +
        '  <select id="index-select" class="form-select" style="width:100%;margin-bottom:10px;">';

    // Add indices from ee-computations.js
    var indices = [
        'NDVI', 'EVI', 'SAVI', 'NDMI', 'GCI', 'NDWI', 'MNDWI', 'NDBI', 'BSI',
        'NBR', 'NDSI', 'ClayRatio', 'IronOxide', 'GypsumIndex', 'CarbonateIndex',
        'ESI', 'SI3', 'SOM', 'Turbidity', 'Chlorophyll-a'
    ];
    indices.forEach(function (idx) {
        html += '<option value="' + idx + '">' + idx + '</option>';
    });

    html += '  </select>' +
        '  <button class="btn" style="width:100%;background:#4CAF50;color:white;" onclick="runResearcherAnalysis(\'update-layer\')">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø¨Ù‚Ø© (Update Layer)</button>' +
        '  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">' +
        '    <button class="btn" style="background:#2196F3;color:white;" onclick="runResearcherAnalysis(\'time-series\')">ğŸ“ˆ Time Series</button>' +
        '    <button class="btn" style="background:#FF9800;color:white;" onclick="runResearcherAnalysis(\'true-color\')">ğŸ“¸ True Color</button>' +
        '  </div>' +
        '</div>';

    html += '<div class="card">' +
        '  <div class="card-title">4) Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</div>' +
        '  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">' +
        '    <button class="btn btn-outline" onclick="runResearcherAnalysis(\'salinity-risk\')">ğŸ§‚ Salinity Risk</button>' +
        '    <button class="btn btn-outline" onclick="runResearcherAnalysis(\'vhi\')">ğŸŒ¾ VHI Model</button>' +
        '    <button class="btn btn-outline" onclick="runResearcherAnalysis(\'drought\')">ğŸŒµ Drought Index</button>' +
        '    <button class="btn btn-outline" onclick="runResearcherAnalysis(\'desert\')">ğŸœï¸ Desert Risk</button>' +
        '    <button class="btn btn-outline" onclick="runResearcherAnalysis(\'lst\')">ğŸŒ¡ï¸ Land Temp</button>' +
        '    <button class="btn btn-outline" onclick="runResearcherAnalysis(\'precip\')">ğŸŒ§ï¸ Precipitation</button>' +
        '  </div>' +
        '</div>';

    html += '<div id="research-stats" class="card" style="display:none;background:#f5f5f5;border:1px dashed #ccc;">' +
        '  <div class="card-title" style="background:#e0e0e0;color:#333;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Stats)</div>' +
        '  <div id="stats-content" style="font-size:12px;padding:5px;"></div>' +
        '</div>';

    html += '<button class="btn btn-back" style="width:100%;margin-top:20px;" onclick="showWelcome()">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>';

    setPanelContent(html);

    // Load governorates list
    loadGovernoratesList();
}

// ------ Researcher Helper: Load Governorates ------
function loadGovernoratesList() {
    var adminBoundariesAsset = 'projects/ee-elsayedfarouk/assets/Egypt_GADM_Boundaries';
    var adminBoundaries = ee.FeatureCollection(adminBoundariesAsset);

    adminBoundaries.aggregate_array('NAME_1').distinct().sort().evaluate(function (list, err) {
        var select = document.getElementById('gov-select');
        if (err || !select) return;

        list.forEach(function (name) {
            var opt = document.createElement('option');
            opt.value = name;
            opt.innerText = name;
            select.appendChild(opt);
        });
    });
}

// ------ Researcher Helper: Handle Gov Change ------
function handleGovChange() {
    var govName = document.getElementById('gov-select').value;
    if (!govName) return;

    var adminBoundariesAsset = 'projects/ee-elsayedfarouk/assets/Egypt_GADM_Boundaries';
    var adminBoundaries = ee.FeatureCollection(adminBoundariesAsset);
    var region = adminBoundaries.filter(ee.Filter.eq('NAME_1', govName));

    region.geometry().evaluate(function (geom) {
        if (!geom) return;
        window.currentRegion = ee.Geometry(geom);

        // Zoom and Highlight on Leaflet
        if (window.map) {
            // Since we don't have a direct GEE highlight layer in Leaflet easily without adding to GEE,
            // we just zoom for now. Full parity would involve creating a tiled layer of the highlight.
            // But for the web app, zooming is the primary action.
        }
    });
}

// ------ Researcher Helper: Run Analysis ------
function runResearcherAnalysis(type) {
    if (!window.currentRegion) {
        alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­Ø§ÙØ¸Ø© Ø£ÙˆÙ„Ø§Ù‹!');
        return;
    }

    var start = document.getElementById('research-start').value;
    var end = document.getElementById('research-end').value;
    var sensor = document.getElementById('sensor-select').value;
    var index = document.getElementById('index-select').value;

    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

    // 1. Get Base Collection
    var col = getAnyCollection(sensor, start, end, window.currentRegion);

    col.size().evaluate(function (size, err) {
        if (err || size === 0) {
            hideLoading();
            alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªÙˆÙØ±Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© / Ø§Ù„Ù…Ø³ØªØ´Ø¹Ø±!');
            return;
        }

        var result = col.median().clip(window.currentRegion);

        if (type === 'update-layer') {
            var indexImg = indicesDict[index](result);
            var vis = visParamsDict[index] || { min: 0, max: 1 };
            addEELayer(indexImg, vis, 'Researcher_' + index);

            // Calculate stats for the selected index
            var stats = indexImg.reduceRegion({
                reducer: ee.Reducer.mean().combine(ee.Reducer.min(), '', true).combine(ee.Reducer.max(), '', true),
                geometry: window.currentRegion,
                scale: 100,
                maxPixels: 1e8
            });

            stats.evaluate(function (res, err) {
                var statsBox = document.getElementById('research-stats');
                var statsContent = document.getElementById('stats-content');
                if (err || !res) return;

                statsBox.style.display = 'block';
                var key = Object.keys(res)[0]; // Get the first key, e.g., 'mean' or 'bandName_mean'
                var meanKey = key.includes('_') ? key.replace('_min', '').replace('_max', '') : 'mean';

                statsContent.innerHTML =
                    '<div><strong>Ø§Ù„Ù…Ø¤Ø´Ø±:</strong> ' + index + '</div>' +
                    '<div><strong>Ø§Ù„Ù…ØªÙˆØ³Ø·:</strong> ' + (res[meanKey] || res[key]).toFixed(3) + '</div>' +
                    '<div><strong>Ø§Ù„Ø£Ø¯Ù†Ù‰:</strong> ' + (res[meanKey + '_min'] || 0).toFixed(3) + '</div>' +
                    '<div><strong>Ø§Ù„Ø£Ù‚ØµÙ‰:</strong> ' + (res[meanKey + '_max'] || 0).toFixed(3) + '</div>';
            });

            alert('ØªÙ… Ø¹Ø±Ø¶ Ø·Ø¨Ù‚Ø©: ' + index);
            hideLoading();
        }
        else if (type === 'true-color') {
            var vis = { min: 0, max: 3000, bands: ['RED', 'GREEN', 'BLUE'] };
            if (sensor.indexOf('Landsat') > -1) vis = { min: 0, max: 0.3, bands: ['RED', 'GREEN', 'BLUE'] };
            addEELayer(result, vis, 'TrueColor_' + sensor);
            hideLoading();
        }
        else if (type === 'salinity-risk') {
            // Advanced Salinity Model ML
            var s1 = getS1Collection(start, end, window.currentRegion).median();
            var soil = getOpenLandMapSoil(window.currentRegion);
            var climate = getEra5(start, end, window.currentRegion).median();

            var salinity = estimateSalinity_ML(result, s1, climate.select('temp'), climate.select('precip'), soil.select('clay'), soil.select('sand'));
            addEELayer(salinity, { min: 0, max: 15, palette: ['blue', 'cyan', 'green', 'yellow', 'orange', 'red'] }, 'Salinity_Risk');
            hideLoading();
        }
        else if (type === 'vhi') {
            var vhi = calculateVHI(start, end, window.currentRegion);
            addEELayer(vhi, { min: 0, max: 1, palette: ['red', 'yellow', 'green'] }, 'VHI_Model');
            hideLoading();
        }
        else if (type === 'drought') {
            var drought = calculateDroughtIndex(start, end, window.currentRegion);
            addEELayer(drought, { min: 0, max: 1, palette: ['red', 'orange', 'yellow', 'green'] }, 'Drought_Index');
            hideLoading();
        }
        else if (type === 'desert') {
            var desert = calculateDesertRisk(start, end, window.currentRegion);
            addEELayer(desert, { min: 0, max: 1, palette: ['green', 'yellow', 'orange', 'red'] }, 'Desert_Risk');
            hideLoading();
        }
        else if (type === 'lst') {
            var colLs = getMergedLandsatCollection(start, end, window.currentRegion);
            var lst = colLs.select('LST').median().clip(window.currentRegion);
            addEELayer(lst, { min: 15, max: 50, palette: ['blue', 'white', 'red'] }, 'LST_Temp');
            hideLoading();
        }
        else if (type === 'precip') {
            var precip = getChirps(start, end, window.currentRegion).clip(window.currentRegion);
            addEELayer(precip, { min: 0, max: 500, palette: ['white', 'blue', 'darkblue'] }, 'Precipitation');
            hideLoading();
        }
        else if (type === 'time-series') {
            // Time Series for Researcher Mode
            var indexImgCol = col.map(function (img) {
                return indicesDict[index](img).copyProperties(img, ['system:time_start']);
            });

            var stats = indexImgCol.map(function (img) {
                var mean = img.reduceRegion({
                    reducer: ee.Reducer.mean(),
                    geometry: window.currentRegion,
                    scale: 500,
                    maxPixels: 1e8
                }).get(index);
                return img.set('mean_val', mean);
            }).filter(ee.Filter.notNull(['mean_val']));

            stats.aggregate_array('mean_val').evaluate(function (data) {
                stats.aggregate_array('system:time_start').evaluate(function (dates) {
                    var statsBox = document.getElementById('research-stats');
                    var statsContent = document.getElementById('stats-content');
                    statsBox.style.display = 'block';
                    statsContent.innerHTML = '<h4>ğŸ“ˆ Time Series: ' + index + '</h4>' +
                        '<div style="height:150px;"><canvas id="researchChart"></canvas></div>';

                    var dateLabels = dates.map(d => new Date(d).toLocaleDateString());
                    setTimeout(function () {
                        new Chart(document.getElementById('researchChart'), {
                            type: 'line',
                            data: {
                                labels: dateLabels,
                                datasets: [{ label: index, data: data, borderColor: '#4CAF50', fill: false }]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }, 100);
                    hideLoading();
                });
            });
        }
        else if (type === 'zonal-stats') {
            // Governorate comparison (All Egypt)
            var indexImg = indicesDict[index](result);
            var boundaries = ee.FeatureCollection('projects/ee-elsayedfarouk/assets/Egypt_GADM_Boundaries');

            var zonalResults = indexImg.reduceRegions({
                collection: boundaries,
                reducer: ee.Reducer.mean().setOutputs(['mean']),
                scale: 1000
            });

            zonalResults.sort('mean', false).limit(10).evaluate(function (res, err) {
                if (err || !res) { hideLoading(); alert('Error calculating zonal stats'); return; }
                var statsBox = document.getElementById('research-stats');
                var statsContent = document.getElementById('stats-content');
                statsBox.style.display = 'block';
                var html = '<strong>ğŸ“Š Ø£Ø¹Ù„Ù‰ 10 Ù…Ø­Ø§ÙØ¸Ø§Øª (' + index + '):</strong><br/>';
                res.features.forEach(function (f) {
                    html += '<div>' + f.properties.NAME_1 + ': ' + (f.properties.mean || 0).toFixed(3) + '</div>';
                });
                statsContent.innerHTML = html;
                hideLoading();
            });
        }
        else {
            alert('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹.');
            hideLoading();
        }
    });
}

// ====== Premium Toggle Handler ======
function togglePremiumSection(id) {
    var content = document.getElementById(id);
    var icon = document.getElementById(id + '-icon');
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.innerText = 'â–¾';
    } else {
        content.style.display = 'none';
        icon.innerText = 'â–¸';
    }
}

// ====== Map Download Handler ======
function downloadFarmMap() {
    if (!window.currentS2Image || !window.currentFarmArea) {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„!');
        return;
    }

    var btn = document.getElementById('btn-download-map');
    var originalText = btn ? btn.innerText : 'ğŸ“¥ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø²Ø±Ø¹Ø©';
    if (btn) btn.innerText = 'â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·...';

    // RGB Visualization
    var visParams = { min: 0, max: 3000, bands: ['B4', 'B3', 'B2'] };

    window.currentS2Image.visualize(visParams).getThumbURL({
        'dimensions': 1000,
        'region': window.currentFarmArea,
        'format': 'png'
    }, function (url) {
        if (btn) btn.innerText = originalText;
        if (url) {
            window.open(url, '_blank');
        } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©.');
        }
    });
}

// ====== Initialization ======
// Initialize Map and Auth
function initApp() {
    console.log('ğŸš€ Initializing App...');
    // Check if ee is defined
    if (typeof ee === 'undefined') {
        console.error('âŒ Critical Error: Google Earth Engine client library not loaded!');
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¬Ø³ÙŠÙ…: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Earth Engine.');
        return;
    }

    // Authenticate using the token from config.js or auth.js
    // Assuming handling in separate auth.js, but let's verify here
    // In our setup, auth.js should have run already.

    console.log('ğŸ”„ Attempting GEE Initialization...');

    // Check if auth token is present (from auth.js)
    var token = ee.data.getAuthToken();
    if (!token) {
        console.warn('âš ï¸ No Auth Token found immediately. Checking cookie/storage...');
    }

    ee.initialize(null, null, function () {
        console.log('âœ… GEE Initialized Successfully!');
        // Update any UI that needs to know GEE is ready
        var status = document.getElementById('loading-overlay');
        if (status) status.style.display = 'none';

        // Validation Check: Try to print something small
        ee.Image(1).evaluate(function (res, err) {
            if (err) console.error('âŒ GEE Test Failed:', err);
            else console.log('âœ… GEE Test Passed (1=1):', res);
        });

        // Enable map interaction
        window.mapClickEnabled = true;
    }, function (e) {
        console.error('âŒ GEE Initialization Failed:', e);
        alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬ÙˆØ¬Ù„ Ø¥ÙŠØ±Ø«: ' + e);
    });
}

// Call init on load
window.addEventListener('load', initApp);
